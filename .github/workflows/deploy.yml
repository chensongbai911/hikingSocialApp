name: Deploy to Production Server

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° master åˆ†æ”¯æˆ–æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          cd /var/www/hikingSocialApp
          git pull origin master

          # æ›´æ–°åç«¯
          cd backend
          npm install --production
          npm run build
          pm2 restart hiking-api

          # æ›´æ–°å‰ç«¯
          cd ../frontend
          npm install
          npm run build

          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          pm2 list

    - name: Health check
      run: |
        sleep 10
        curl -f ${{ secrets.API_URL }}/api/v1/health || exit 1
        echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"

    - name: Notify on success
      if: success()
      run: echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"

    - name: Notify on failure
      if: failure()
      run: echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
