name: Deploy to Cloud Server

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Build backend
      run: |
        cd backend
        npm ci
        npm run build

    - name: Deploy to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        source: "backend/dist,backend/package.json,backend/package-lock.json,backend/.env.example,backend/ecosystem.config.cjs,frontend"
        target: "/tmp/hikingSocialApp"
        strip_components: 0

    - name: Execute deployment commands
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          set -e
          set -o pipefail

          echo "=========================================="
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
          echo "=========================================="

          PROJECT_DIR="/var/www/hikingSocialApp"
          TEMP_DIR="/tmp/hikingSocialApp"

          # ç¡®ä¿é¡¹ç›®ç›®å½•å­˜åœ¨
          mkdir -p "$PROJECT_DIR" || (echo "âŒ æ— æ³•åˆ›å»ºé¡¹ç›®ç›®å½•" && exit 1)

          # å¤‡ä»½ç°æœ‰ç¯å¢ƒå˜é‡æ–‡ä»¶
          if [ -f "$PROJECT_DIR/backend/.env" ]; then
            echo "ğŸ“¦ å¤‡ä»½ç¯å¢ƒå˜é‡æ–‡ä»¶..."
            cp "$PROJECT_DIR/backend/.env" "/tmp/backend.env.backup"
          fi

          # åŒæ­¥ä»£ç ï¼ˆä»ä¸´æ—¶ç›®å½•åˆ°é¡¹ç›®ç›®å½•ï¼‰
          echo "ğŸ“¥ åŒæ­¥ä»£ç ..."
          rsync -av --delete "$TEMP_DIR/backend/" "$PROJECT_DIR/backend/" || (echo "âŒ åç«¯åŒæ­¥å¤±è´¥" && exit 1)
          rsync -av --delete "$TEMP_DIR/frontend/" "$PROJECT_DIR/frontend/" || (echo "âŒ å‰ç«¯åŒæ­¥å¤±è´¥" && exit 1)

          # æ¢å¤ç¯å¢ƒå˜é‡æ–‡ä»¶
          if [ -f "/tmp/backend.env.backup" ]; then
            cp "/tmp/backend.env.backup" "$PROJECT_DIR/backend/.env"
            rm "/tmp/backend.env.backup"
          fi

          # æ¸…ç†ä¸´æ—¶ç›®å½•
          rm -rf "$TEMP_DIR"

          # åç«¯éƒ¨ç½²
          echo "=========================================="
          echo "ğŸ”§ éƒ¨ç½²åç«¯..."
          echo "=========================================="
          cd "$PROJECT_DIR/backend"

          echo "ğŸ“¦ å®‰è£…ç”Ÿäº§ä¾èµ–..."
          npm ci --production || npm install --production || (echo "âŒ npm install å¤±è´¥" && exit 1)

          # é‡å¯åç«¯æœåŠ¡
          echo "ğŸ”„ é‡å¯åç«¯æœåŠ¡..."
          if pm2 list | grep -q hiking-app-backend; then
            pm2 restart ecosystem.config.cjs --only hiking-app-backend --env production || (echo "âŒ é‡å¯å¤±è´¥" && exit 1)
          else
            pm2 start ecosystem.config.cjs --env production || (echo "âŒ å¯åŠ¨å¤±è´¥" && exit 1)
          fi
          pm2 save

          # å‰ç«¯éƒ¨ç½²
          echo "=========================================="
          echo "ğŸ¨ éƒ¨ç½²å‰ç«¯..."
          echo "=========================================="
          cd "$PROJECT_DIR/frontend"

          if [ ! -d node_modules ]; then
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm install || (echo "âŒ å‰ç«¯ä¾èµ–å®‰è£…å¤±è´¥" && exit 1)
          fi

          echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
          npm run build || (echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥" && exit 1)

          # é‡å¯ Nginx
          echo "ğŸ”„ é‡å¯ Nginx..."
          sudo systemctl reload nginx || true

          echo "=========================================="
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "=========================================="

          # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
          pm2 list

    - name: Health check
      run: |
        sleep 8
        echo "ğŸ¥ å¥åº·æ£€æŸ¥..."

        # æ£€æŸ¥åç«¯ API
        for i in {1..5}; do
          echo "å°è¯•è¿æ¥åç«¯ ($i/5)..."
          if curl -s -f http://115.190.252.62:3000/api/v1/activities?page=1 -H "Accept: application/json" > /dev/null; then
            echo "âœ… åç«¯ API å¥åº·æ£€æŸ¥é€šè¿‡"
            break
          else
            if [ $i -lt 5 ]; then
              echo "â³ ç­‰å¾…ä¸­..."
              sleep 3
            else
              echo "âš ï¸ åç«¯å¯èƒ½è¿˜åœ¨å¯åŠ¨ï¼Œç»§ç»­éƒ¨ç½²"
            fi
          fi
        done

        # æ£€æŸ¥å‰ç«¯
        echo "æ£€æŸ¥å‰ç«¯..."
        if curl -s -f http://115.190.252.62/ > /dev/null; then
          echo "âœ… å‰ç«¯å¯è®¿é—®"
        else
          echo "âš ï¸ å‰ç«¯å¯èƒ½è¿˜åœ¨å¯åŠ¨"
        fi

    - name: Notify status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "âœ… å‰ç«¯: http://115.190.252.62"
          echo "âœ… åç«¯ API: http://115.190.252.62:3000/api/v1"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥"
          echo "è¯·æ£€æŸ¥ä¸Šé¢çš„é”™è¯¯æ—¥å¿—"
        fi

    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
        echo "å¤±è´¥çš„æ­¥éª¤çŠ¶æ€: ${{ job.status }}"
