name: Deploy to Cloud Server

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          set -e
          set -o pipefail

          echo "=========================================="
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
          echo "=========================================="

          PROJECT_DIR="/var/www/hikingSocialApp"

          # ç¡®ä¿é¡¹ç›®ç›®å½•å­˜åœ¨
          mkdir -p "$PROJECT_DIR" || (echo "âŒ æ— æ³•åˆ›å»ºé¡¹ç›®ç›®å½•" && exit 1)

          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd "$PROJECT_DIR"

          # æ£€æŸ¥æ˜¯å¦æ˜¯ git ä»“åº“
          if [ ! -d .git ]; then
            echo "ğŸ“¥ åˆå§‹åŒ– Git ä»“åº“..."
            git clone https://github.com/chensongbai911/hikingSocialApp.git . || (echo "âŒ å…‹éš†å¤±è´¥" && exit 1)
          fi

          # æ‹‰å–æœ€æ–°ä»£ç 
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
          git fetch origin master || (echo "âŒ git fetch å¤±è´¥" && exit 1)
          git reset --hard origin/master || (echo "âŒ git reset å¤±è´¥" && exit 1)

          # åç«¯éƒ¨ç½²
          echo "=========================================="
          echo "ğŸ”§ éƒ¨ç½²åç«¯..."
          echo "=========================================="
          cd "$PROJECT_DIR/backend"

          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm install || (echo "âŒ npm install å¤±è´¥" && exit 1)

          echo "ğŸ”¨ ç¼–è¯‘ TypeScript..."
          npm run build || (echo "âŒ ç¼–è¯‘å¤±è´¥" && exit 1)

          # é‡å¯åç«¯æœåŠ¡
          echo "ğŸ”„ é‡å¯åç«¯æœåŠ¡..."
          if pm2 list | grep -q hiking-api; then
            pm2 restart hiking-api --env production || (echo "âŒ é‡å¯å¤±è´¥" && exit 1)
          else
            pm2 start dist/server.js --name hiking-api --env production || (echo "âŒ å¯åŠ¨å¤±è´¥" && exit 1)
          fi
          pm2 save

          # å‰ç«¯éƒ¨ç½²
          echo "=========================================="
          echo "ğŸ¨ éƒ¨ç½²å‰ç«¯..."
          echo "=========================================="
          cd "$PROJECT_DIR/frontend"
          
          if [ ! -d node_modules ]; then
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm install || (echo "âŒ å‰ç«¯ä¾èµ–å®‰è£…å¤±è´¥" && exit 1)
          fi

          echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
          npm run build || (echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥" && exit 1)

          # é‡å¯ Nginx
          echo "ğŸ”„ é‡å¯ Nginx..."
          sudo systemctl reload nginx || true

          echo "=========================================="
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "=========================================="

          # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
          pm2 list

    - name: Health check
      run: |
        sleep 8
        echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
        
        # æ£€æŸ¥åç«¯ API
        for i in {1..5}; do
          echo "å°è¯•è¿æ¥åç«¯ ($i/5)..."
          if curl -s -f http://115.190.252.62:3000/api/v1/activities?page=1 -H "Accept: application/json" > /dev/null; then
            echo "âœ… åç«¯ API å¥åº·æ£€æŸ¥é€šè¿‡"
            break
          else
            if [ $i -lt 5 ]; then
              echo "â³ ç­‰å¾…ä¸­..."
              sleep 3
            else
              echo "âš ï¸ åç«¯å¯èƒ½è¿˜åœ¨å¯åŠ¨ï¼Œç»§ç»­éƒ¨ç½²"
            fi
          fi
        done
        
        # æ£€æŸ¥å‰ç«¯
        echo "æ£€æŸ¥å‰ç«¯..."
        if curl -s -f http://115.190.252.62/ > /dev/null; then
          echo "âœ… å‰ç«¯å¯è®¿é—®"
        else
          echo "âš ï¸ å‰ç«¯å¯èƒ½è¿˜åœ¨å¯åŠ¨"
        fi

    - name: Notify status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "âœ… å‰ç«¯: http://115.190.252.62"
          echo "âœ… åç«¯ API: http://115.190.252.62:3000/api/v1"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥"
          echo "è¯·æ£€æŸ¥ä¸Šé¢çš„é”™è¯¯æ—¥å¿—"
        fi

    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
        echo "å¤±è´¥çš„æ­¥éª¤çŠ¶æ€: ${{ job.status }}"
