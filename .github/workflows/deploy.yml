name: Deploy to Cloud Server

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          set -e

          echo "=========================================="
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
          echo "=========================================="

          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /var/www/hikingSocialApp

          # æ‹‰å–æœ€æ–°ä»£ç 
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
          git fetch origin
          git reset --hard origin/master
          git pull origin master

          # åç«¯éƒ¨ç½²
          echo "=========================================="
          echo "ğŸ”§ éƒ¨ç½²åç«¯..."
          echo "=========================================="
          cd backend
          npm install

          # é‡å¯åç«¯æœåŠ¡ï¼ˆä½¿ç”¨ tsx è¿è¡Œï¼‰
          echo "ğŸ”„ é‡å¯åç«¯æœåŠ¡..."
          pm2 restart hiking-api || pm2 start --name hiking-api --interpreter tsx src/server.ts --env production
          pm2 save

          # å‰ç«¯éƒ¨ç½²
          echo "=========================================="
          echo "ğŸ¨ éƒ¨ç½²å‰ç«¯..."
          echo "=========================================="
          cd /var/www/hikingSocialApp/frontend
          npm install
          npm run build

          # é‡å¯ Nginx
          echo "ğŸ”„ é‡å¯ Nginx..."
          sudo systemctl reload nginx

          echo "=========================================="
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "=========================================="

          # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
          pm2 list

    - name: Health check
      run: |
        sleep 5
        echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
        curl -f http://115.190.252.62/ || echo "âš ï¸ å‰ç«¯æ£€æŸ¥å¤±è´¥"

    - name: Notify status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼è®¿é—®: http://115.190.252.62"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi

    - name: Notify on failure
      if: failure()
      run: echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
