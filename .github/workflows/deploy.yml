name: Deploy to Cloud Server

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          set -e
          set -o pipefail

          echo "=========================================="
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
          echo "=========================================="

          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /var/www/hikingSocialApp || (echo "âŒ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨" && exit 1)

          # æ‹‰å–æœ€æ–°ä»£ç 
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
          git fetch origin master
          git reset --hard origin/master

          # åç«¯éƒ¨ç½²
          echo "=========================================="
          echo "ğŸ”§ éƒ¨ç½²åç«¯..."
          echo "=========================================="
          cd backend

          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm install || (echo "âŒ npm install å¤±è´¥" && exit 1)

          echo "ğŸ”¨ ç¼–è¯‘ TypeScript..."
          npm run build || (echo "âŒ ç¼–è¯‘å¤±è´¥" && exit 1)

          # é‡å¯åç«¯æœåŠ¡
          echo "ğŸ”„ é‡å¯åç«¯æœåŠ¡..."
          if pm2 list | grep -q hiking-api; then
            pm2 restart hiking-api || (echo "âŒ é‡å¯å¤±è´¥" && exit 1)
          else
            pm2 start dist/server.js --name hiking-api --env production || (echo "âŒ å¯åŠ¨å¤±è´¥" && exit 1)
          fi
          pm2 save

          # å‰ç«¯éƒ¨ç½²
          echo "=========================================="
          echo "ğŸ¨ éƒ¨ç½²å‰ç«¯..."
          echo "=========================================="
          cd /var/www/hikingSocialApp/frontend || (echo "âŒ å‰ç«¯ç›®å½•ä¸å­˜åœ¨" && exit 1)

          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm install || (echo "âŒ å‰ç«¯ä¾èµ–å®‰è£…å¤±è´¥" && exit 1)

          echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
          npm run build || (echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥" && exit 1)

          # é‡å¯ Nginx
          echo "ğŸ”„ é‡å¯ Nginx..."
          sudo systemctl reload nginx || true

          echo "=========================================="
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "=========================================="

          # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
          pm2 list

    - name: Health check
      run: |
        sleep 5
        echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
        for i in {1..3}; do
          if curl -f http://115.190.252.62:3000/api/v1/activities -H "Accept: application/json"; then
            echo "âœ… åç«¯å¥åº·æ£€æŸ¥é€šè¿‡"
            break
          else
            echo "âš ï¸ å°è¯• $i/3 å¤±è´¥ï¼Œç­‰å¾…..."
            sleep 2
          fi
        done
        echo "å‰ç«¯æ£€æŸ¥..."
        curl -f http://115.190.252.62/ || echo "âš ï¸ å‰ç«¯å¯èƒ½è¿˜åœ¨å¯åŠ¨"

    - name: Notify status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "âœ… å‰ç«¯: http://115.190.252.62"
          echo "âœ… åç«¯ API: http://115.190.252.62:3000/api/v1"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥"
          echo "è¯·æ£€æŸ¥ä¸Šé¢çš„é”™è¯¯æ—¥å¿—"
        fi

    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
        echo "å¤±è´¥çš„æ­¥éª¤çŠ¶æ€: ${{ job.status }}"
