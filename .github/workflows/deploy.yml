name: Deploy to Cloud Server

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Build backend
      run: |
        cd backend
        npm ci

        # æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶
        rm -rf dist

        # æ„å»º
        npm run build

        # éªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        echo "âœ“ éªŒè¯æ„å»ºæ–‡ä»¶..."
        test -f dist/server.js || (echo "âŒ server.js ç¼ºå¤±" && exit 1)
        test -d dist/config || (echo "âŒ config ç›®å½•ç¼ºå¤±" && exit 1)
        test -f dist/config/sequelize.js || (echo "âŒ sequelize.js ç¼ºå¤±" && exit 1)
        test -d dist/routes || (echo "âŒ routes ç›®å½•ç¼ºå¤±" && exit 1)

        echo "âœ… æ‰€æœ‰å…³é”®æ–‡ä»¶éªŒè¯é€šè¿‡"
        ls -la dist/
        ls -la dist/config/
        ls -la dist/routes/

    - name: Prepare deployment package
      run: |
        echo "ğŸ“¦ å‡†å¤‡éƒ¨ç½²åŒ…..."
        mkdir -p deploy-package/backend
        mkdir -p deploy-package/frontend
        mkdir -p deploy-package/nginx

        # å¤åˆ¶åç«¯å¿…è¦æ–‡ä»¶
        cp -r backend/dist deploy-package/backend/
        cp backend/package.json deploy-package/backend/
        cp backend/package-lock.json deploy-package/backend/
        cp backend/.env.example deploy-package/backend/
        cp backend/ecosystem.config.cjs deploy-package/backend/

        # å¤åˆ¶å‰ç«¯æ–‡ä»¶ï¼ˆæ’é™¤ node_modulesï¼‰
        rsync -av --exclude='node_modules' --exclude='.git' --exclude='*.log' frontend/ deploy-package/frontend/

        # å¤åˆ¶ Nginx é…ç½®
        cp nginx/hiking-app-single-server.conf deploy-package/nginx/
        echo "âœ… å·²åŒ…å« Nginx é…ç½®"

        echo "âœ… éƒ¨ç½²åŒ…å‡†å¤‡å®Œæˆ"
        du -sh deploy-package/*

        # åˆ›å»ºå‹ç¼©åŒ…ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        echo "ğŸ“¦ åˆ›å»ºå‹ç¼©åŒ…..."
        tar -czf deploy-package.tar.gz -C deploy-package .
        ls -lh deploy-package.tar.gz

    - name: Upload deploy artifact (for debugging/manual deploy)
      uses: actions/upload-artifact@v4
      with:
        name: deploy-package
        path: deploy-package.tar.gz
        retention-days: 3

    - name: Deploy to server (Attempt 1)
      uses: appleboy/scp-action@v0.1.7
      continue-on-error: true
      id: scp_deploy
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        source: "deploy-package.tar.gz"
        target: "/tmp/"
        timeout: 20m
        command_timeout: 20m
        overwrite: true
        strip_components: 0
        rm: false
        use_insecure_cipher: true
      env:
        DEBUG: true

    - name: Retry deploy if failed (Attempt 2)
      if: steps.scp_deploy.outcome != 'success'
      uses: appleboy/scp-action@v0.1.7
      continue-on-error: true
      id: scp_deploy_retry
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        source: "deploy-package.tar.gz"
        target: "/tmp/"
        timeout: 20m
        command_timeout: 20m
        overwrite: true
        use_insecure_cipher: true
      env:
        DEBUG: true

    - name: Retry deploy if failed (Attempt 3)
      if: steps.scp_deploy.outcome != 'success' && steps.scp_deploy_retry.outcome != 'success'
      uses: appleboy/scp-action@v0.1.7
      continue-on-error: true
      id: scp_deploy_retry2
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        source: "deploy-package.tar.gz"
        target: "/tmp/"
        timeout: 25m
        command_timeout: 25m
        overwrite: true
        use_insecure_cipher: true
      env:
        DEBUG: true

    - name: Extract package on server
      if: steps.scp_deploy.outcome == 'success' || steps.scp_deploy_retry.outcome == 'success' || steps.scp_deploy_retry2.outcome == 'success'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          echo "ğŸ“¦ è§£å‹éƒ¨ç½²åŒ…..."
          rm -rf /tmp/hikingSocialApp
          mkdir -p /tmp/hikingSocialApp
          tar -xzf /tmp/deploy-package.tar.gz -C /tmp/hikingSocialApp/
          echo "âœ… è§£å‹å®Œæˆ"
          ls -lah /tmp/hikingSocialApp/

    - name: Try alternative deployment method
      if: steps.scp_deploy.outcome != 'success' && steps.scp_deploy_retry.outcome != 'success' && steps.scp_deploy_retry2.outcome != 'success'
      uses: appleboy/ssh-action@v1.0.3
      continue-on-error: true
      id: alternative_deploy
      env:
        DEPLOY_PAT: ${{ secrets.DEPLOY_PAT }}
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          echo "ğŸ”„ å°è¯•å¤‡ç”¨éƒ¨ç½²æ–¹æ³•ï¼šç›´æ¥ä» Git æ‹‰å–..."
          cd /var/www/hikingSocialApp || mkdir -p /var/www/hikingSocialApp

          REPO_URL="https://github.com/${{ github.repository }}.git"
          if [ -n "$DEPLOY_PAT" ]; then
            REPO_URL="https://${DEPLOY_PAT}@github.com/${{ github.repository }}.git"
          fi

          if [ -d ".git" ]; then
            echo "æ›´æ–°ç°æœ‰ä»“åº“..."
            git remote set-url origin "$REPO_URL"
            git fetch origin
            git reset --hard origin/master
          else
            echo "å…‹éš†æ–°ä»“åº“..."
            cd /var/www
            rm -rf hikingSocialApp
            git clone "$REPO_URL" hikingSocialApp
            cd hikingSocialApp
          fi

          echo "âœ… ä»£ç å·²æ›´æ–°"

    - name: Fallback - Manual deployment instruction
      if: |
        steps.scp_deploy.outcome != 'success' &&
        steps.scp_deploy_retry.outcome != 'success' &&
        steps.scp_deploy_retry2.outcome != 'success' &&
        steps.alternative_deploy.outcome != 'success'
      run: |
        echo "âš ï¸  è‡ªåŠ¨éƒ¨ç½²å¤šæ¬¡å¤±è´¥"
        echo ""
        echo "ğŸ“‹ æ‰‹åŠ¨éƒ¨ç½²æ­¥éª¤ï¼š"
        echo "æ–¹æ¡ˆ 1 - ä½¿ç”¨ SCPï¼š"
        echo "  1. scp deploy-package.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/"
        echo "  2. ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
        echo "  3. cd /tmp && tar -xzf deploy-package.tar.gz"
        echo ""
        echo "æ–¹æ¡ˆ 2 - ä½¿ç”¨ Gitï¼š"
        echo "  1. ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
        echo "  2. cd /var/www/hikingSocialApp"
        echo "  3. git pull origin master"
        echo ""
        echo "âš ï¸  æ³¨æ„ï¼šè¿™ä¸ä¼šåœæ­¢éƒ¨ç½²æµç¨‹ï¼Œå°†ç»§ç»­ä½¿ç”¨ç°æœ‰ä»£ç "

    - name: Verify upload
      if: steps.scp_deploy.outcome == 'success' || steps.scp_deploy_retry.outcome == 'success' || steps.scp_deploy_retry2.outcome == 'success'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          echo "âœ… éªŒè¯ä¸Šä¼ æ–‡ä»¶..."
          ls -lah /tmp/hikingSocialApp/
          echo "åç«¯æ–‡ä»¶:"
          ls -lah /tmp/hikingSocialApp/backend/ || echo "åç«¯ç›®å½•ä¸å­˜åœ¨"
          echo "å‰ç«¯æ–‡ä»¶:"
          ls -lah /tmp/hikingSocialApp/frontend/ || echo "å‰ç«¯ç›®å½•ä¸å­˜åœ¨"

    - name: Execute deployment commands
      # ä»…å½“ SCP ä¸Šä¼ æˆåŠŸæˆ– Git å¤‡ç”¨æ–¹æ¡ˆæˆåŠŸæ—¶æ‰æ‰§è¡Œéƒ¨ç½²å‘½ä»¤ï¼Œé¿å…åœ¨æ— æ³•è®¿é—® GitHub æ—¶è¯¯ç”¨ Git å¯¼è‡´å¤±è´¥
      if: |
        steps.scp_deploy.outcome == 'success' ||
        steps.scp_deploy_retry.outcome == 'success' ||
        steps.scp_deploy_retry2.outcome == 'success' ||
        steps.alternative_deploy.outcome == 'success'
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          set -e
          set -o pipefail

          echo "=========================================="
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
          echo "=========================================="

          PROJECT_DIR="/var/www/hikingSocialApp"
          TEMP_DIR="/tmp/hikingSocialApp"

          # ç¡®ä¿é¡¹ç›®ç›®å½•å­˜åœ¨
          mkdir -p "$PROJECT_DIR" || (echo "âŒ æ— æ³•åˆ›å»ºé¡¹ç›®ç›®å½•" && exit 1)

          # æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆSCP è§£å‹äº§ç‰©ï¼‰
          if [ -d "$TEMP_DIR/backend" ] && [ -d "$TEMP_DIR/frontend" ]; then
            echo "âœ… æ£€æµ‹åˆ°ä¸Šä¼ çš„éƒ¨ç½²åŒ…ï¼Œä½¿ç”¨ SCP æ–¹å¼..."

            # å¤‡ä»½ç°æœ‰ç¯å¢ƒå˜é‡æ–‡ä»¶
            if [ -f "$PROJECT_DIR/backend/.env" ]; then
              echo "ğŸ“¦ å¤‡ä»½ç¯å¢ƒå˜é‡æ–‡ä»¶..."
              cp "$PROJECT_DIR/backend/.env" "/tmp/backend.env.backup"
            fi

            # åŒæ­¥ä»£ç ï¼ˆä»ä¸´æ—¶ç›®å½•åˆ°é¡¹ç›®ç›®å½•ï¼‰
            echo "ğŸ“¥ åŒæ­¥ä»£ç ..."
            rsync -av --delete "$TEMP_DIR/backend/" "$PROJECT_DIR/backend/" || (echo "âŒ åç«¯åŒæ­¥å¤±è´¥" && exit 1)
            rsync -av --delete "$TEMP_DIR/frontend/" "$PROJECT_DIR/frontend/" || (echo "âŒ å‰ç«¯åŒæ­¥å¤±è´¥" && exit 1)

            # æ¢å¤ç¯å¢ƒå˜é‡æ–‡ä»¶
            if [ -f "/tmp/backend.env.backup" ]; then
              cp "/tmp/backend.env.backup" "$PROJECT_DIR/backend/.env"
              rm "/tmp/backend.env.backup"
            fi

            # æ¸…ç†ä¸´æ—¶ç›®å½•
            rm -rf "$TEMP_DIR"
          elif [ -d "$PROJECT_DIR/.git" ]; then
            echo "âœ… æ£€æµ‹åˆ° Git ä»“åº“ï¼Œä½¿ç”¨ Git æ–¹å¼éƒ¨ç½²..."
            echo "ä»£ç å·²é€šè¿‡ Git å¤‡ç”¨æ–¹æ¡ˆæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬"

            # å¤‡ä»½ç¯å¢ƒå˜é‡æ–‡ä»¶
            if [ -f "$PROJECT_DIR/backend/.env" ]; then
              echo "ğŸ“¦ å¤‡ä»½ç¯å¢ƒå˜é‡æ–‡ä»¶..."
              cp "$PROJECT_DIR/backend/.env" "/tmp/backend.env.backup"
            fi

            # ç¡®ä¿åç«¯æœ‰ dist ç›®å½•ï¼ˆGit æ–¹å¼éœ€è¦é‡æ–°æ„å»ºï¼‰
            if [ ! -d "$PROJECT_DIR/backend/dist" ]; then
              echo "ğŸ”¨ åç«¯éœ€è¦é‡æ–°æ„å»º..."
              cd "$PROJECT_DIR/backend"
              npm ci || (echo "âŒ åç«¯ä¾èµ–å®‰è£…å¤±è´¥" && exit 1)
              npm run build || (echo "âŒ åç«¯æ„å»ºå¤±è´¥" && exit 1)
            fi

            # æ¢å¤ç¯å¢ƒå˜é‡æ–‡ä»¶
            if [ -f "/tmp/backend.env.backup" ]; then
              cp "/tmp/backend.env.backup" "$PROJECT_DIR/backend/.env"
              rm "/tmp/backend.env.backup"
            fi
          else
            echo "âŒ æœªæ£€æµ‹åˆ°éƒ¨ç½²åŒ…æˆ– Git ä»“åº“"
            echo "è¯·æ£€æŸ¥ï¼š"
            echo "  1. SCP ä¸Šä¼ æ˜¯å¦æˆåŠŸï¼ˆæŸ¥çœ‹ /tmp/hikingSocialAppï¼‰"
            echo "  2. Git å¤‡ç”¨æ–¹æ¡ˆæ˜¯å¦æˆåŠŸï¼ˆæŸ¥çœ‹ /var/www/hikingSocialApp/.gitï¼‰"
            exit 1
          fi

          # åç«¯éƒ¨ç½²
          echo "=========================================="
          echo "ğŸ”§ éƒ¨ç½²åç«¯..."
          echo "=========================================="
          cd "$PROJECT_DIR/backend"

          # å®‰è£…ä¾èµ–ï¼ˆä»…åœ¨ node_modules ä¸å­˜åœ¨æˆ– package-lock.json æœ‰æ›´æ–°æ—¶ï¼‰
          if [ ! -d node_modules ]; then
            echo "ğŸ“¦ å®‰è£…ç”Ÿäº§ä¾èµ–..."
            npm ci --omit=dev || (echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥" && exit 1)
          fi

          # æ£€æŸ¥ç¯å¢ƒå˜é‡æ–‡ä»¶
          if [ ! -f .env ]; then
            echo "âš ï¸ .env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä»æ¨¡æ¿åˆ›å»º..."
            cp .env.example .env
            echo "è¯·æ‰‹åŠ¨é…ç½® /var/www/hikingSocialApp/backend/.env"
          fi

          # PM2 é‡å¯åç«¯
          echo "ğŸ”„ é‡å¯åç«¯æœåŠ¡..."
          if pm2 list | grep -q "hiking-app-backend"; then
            echo "é‡å¯ç°æœ‰æœåŠ¡..."
            pm2 restart hiking-app-backend --update-env || (
              echo "âš ï¸ é‡å¯å¤±è´¥ï¼Œå°è¯•é‡æ–°å¯åŠ¨..." &&
              pm2 delete hiking-app-backend || true &&
              pm2 start ecosystem.config.cjs --env production --update-env || (echo "âŒ å¯åŠ¨å¤±è´¥" && exit 1)
            )
          else
            echo "é¦–æ¬¡å¯åŠ¨æœåŠ¡..."
            pm2 start ecosystem.config.cjs --env production --update-env || (echo "âŒ å¯åŠ¨å¤±è´¥" && exit 1)
          fi
          pm2 save

          # ç­‰å¾…åç«¯å¯åŠ¨
          echo "â³ ç­‰å¾…åç«¯å¯åŠ¨..."
          sleep 3

          # éªŒè¯åç«¯å¯åŠ¨æˆåŠŸ
          if pm2 list | grep hiking-app-backend | grep -q "online"; then
            echo "âœ… åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ"
          else
            echo "âŒ åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
            pm2 logs hiking-app-backend --lines 30 --nostream
            exit 1
          fi

          # å‰ç«¯éƒ¨ç½²
          echo "=========================================="
          echo "ğŸ¨ éƒ¨ç½²å‰ç«¯..."
          echo "=========================================="
          cd "$PROJECT_DIR/frontend"

          if [ ! -d node_modules ]; then
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm install || (echo "âŒ å‰ç«¯ä¾èµ–å®‰è£…å¤±è´¥" && exit 1)
          fi

          echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
          npm run build || (echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥" && exit 1)

          # éƒ¨ç½² Nginx é…ç½®
          echo "=========================================="
          echo "ğŸ”§ éƒ¨ç½² Nginx é…ç½®..."
          echo "=========================================="
          PROJECT_NGINX_CONF="$PROJECT_DIR/nginx/hiking-app-single-server.conf"

          if [ ! -f "$PROJECT_NGINX_CONF" ]; then
            echo "âš ï¸ é¡¹ç›®ä¸­æ‰¾ä¸åˆ° Nginx é…ç½®æ–‡ä»¶ï¼š$PROJECT_NGINX_CONF"
            echo "è·³è¿‡ Nginx é…ç½®éƒ¨ç½²"
          else
            echo "ğŸ“ æ£€æµ‹ Nginx é…ç½®ç›®å½•ç»“æ„..."

            # æ£€æŸ¥ä¸åŒçš„ Nginx é…ç½®ç›®å½•
            if [ -d "/etc/nginx/sites-available" ]; then
              NGINX_CONF="/etc/nginx/sites-available/default"
              NGINX_ENABLED="/etc/nginx/sites-enabled/default"
              USE_SITES_STRUCTURE=true
            elif [ -d "/etc/nginx/conf.d" ]; then
              NGINX_CONF="/etc/nginx/conf.d/hiking-app.conf"
              USE_SITES_STRUCTURE=false
            else
              echo "âš ï¸ æ— æ³•æ‰¾åˆ° Nginx é…ç½®ç›®å½•ï¼Œè·³è¿‡é…ç½®éƒ¨ç½²"
              NGINX_CONF=""
            fi

            if [ -n "$NGINX_CONF" ]; then
              echo "âœ“ ä½¿ç”¨ Nginx é…ç½®è·¯å¾„ï¼š$NGINX_CONF"

              # åˆ›å»ºé…ç½®ç›®å½•
              sudo mkdir -p "$(dirname "$NGINX_CONF")" || true

              # å¤‡ä»½ç°æœ‰é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
              if [ -f "$NGINX_CONF" ]; then
                echo "ğŸ“‹ å¤‡ä»½ç°æœ‰ Nginx é…ç½®..."
                sudo cp "$NGINX_CONF" "$NGINX_CONF.backup.$(date +%Y%m%d_%H%M%S)" || true
              fi

              # éƒ¨ç½²æ–°é…ç½®
              echo "ğŸ“ éƒ¨ç½²æ–°çš„ Nginx é…ç½®..."
              sudo cp "$PROJECT_NGINX_CONF" "$NGINX_CONF" || (echo "âŒ Nginx é…ç½®å¤åˆ¶å¤±è´¥" && exit 1)

              # å¯¹äº sites-available æ¨¡å¼ï¼Œéœ€è¦åˆ›å»º symlink åˆ° sites-enabled
              if [ "$USE_SITES_STRUCTURE" = true ]; then
                echo "ğŸ“Œ åˆ›å»º sites-enabled symlink..."
                sudo mkdir -p /etc/nginx/sites-enabled || true
                sudo ln -sf "$NGINX_CONF" "$NGINX_ENABLED" || true
              fi

              # éªŒè¯ Nginx é…ç½®
              echo "âœ“ éªŒè¯ Nginx é…ç½®..."
              sudo nginx -t || (echo "âŒ Nginx é…ç½®éªŒè¯å¤±è´¥" && exit 1)

              # é‡å¯ Nginx
              echo "ğŸ”„ é‡å¯ Nginx..."
              sudo systemctl reload nginx || (echo "âš ï¸ systemctl reload å¤±è´¥ï¼Œå°è¯• service..." && sudo service nginx reload) || (echo "âŒ Nginx é‡å¯å¤±è´¥" && exit 1)
            fi
          fi

          echo "=========================================="
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "=========================================="

          # æ¸…ç†ä¸´æ—¶ç›®å½•
          if [ -d "$TEMP_DIR" ]; then
            echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶ç›®å½•..."
            rm -rf "$TEMP_DIR"
          fi

          # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
          pm2 list

    # å¦‚æœ SCP å’Œ Git å¤‡ç”¨æ–¹æ¡ˆéƒ½å¤±è´¥ï¼Œç›´æ¥æ ‡è®°å¤±è´¥ï¼Œé¿å…ç»§ç»­åç»­å¥åº·æ£€æŸ¥è¯¯å¯¼
    - name: Abort when no package available
      if: |
        steps.scp_deploy.outcome != 'success' &&
        steps.scp_deploy_retry.outcome != 'success' &&
        steps.scp_deploy_retry2.outcome != 'success' &&
        steps.alternative_deploy.outcome != 'success'
      run: |
        echo "âŒ éƒ¨ç½²å¤±è´¥ï¼šä¸Šä¼ åŒ…å’Œ Git å¤‡ç”¨æ–¹æ¡ˆå‡æœªæˆåŠŸã€‚"
        echo "ğŸ“‹ è¯·å…ˆæ‰‹åŠ¨ä¸Šä¼  deploy-package.tar.gz è‡³ /tmp å¹¶è§£å‹åˆ° /tmp/hikingSocialAppï¼Œå†é‡æ–°è¿è¡Œéƒ¨ç½²ã€‚"
        exit 1

    - name: Health check
      continue-on-error: true
      run: |
        sleep 8
        echo "ğŸ¥ å¥åº·æ£€æŸ¥..."

        # è®¾ç½®curlè¶…æ—¶å‚æ•°
        CURL_TIMEOUT="--connect-timeout 10 --max-time 15"

        # æ³¨å†Œæµ‹è¯•ç”¨æˆ·å’Œè·å– tokenï¼ˆç”¨äº API æµ‹è¯•ï¼‰
        echo "ğŸ“ æ³¨å†Œæµ‹è¯•ç”¨æˆ·..."
        TEST_USER="healthcheck_$(date +%s)"
        REGISTER_RESPONSE=$(curl -s $CURL_TIMEOUT -X POST http://115.190.252.62:3000/api/v1/auth/register \
          -H "Content-Type: application/json" \
          -d "{\"email\":\"$TEST_USER@test.com\",\"password\":\"test123456\",\"nickname\":\"$TEST_USER\"}" || echo "")

        TEST_TOKEN=$(echo "$REGISTER_RESPONSE" | grep -o '"token":"[^"]*' | cut -d'"' -f4 || echo "")
        if [ -z "$TEST_TOKEN" ]; then
          echo "âš ï¸ æ— æ³•è·å–æµ‹è¯• tokenï¼Œè·³è¿‡è¯¦ç»† API æµ‹è¯•"
        else
          echo "âœ… è·å¾—æµ‹è¯• token"
        fi

        # æ£€æŸ¥åç«¯ APIï¼ˆç›´æ¥è¿æ¥ï¼‰
        echo "ğŸ“Œ æ£€æŸ¥åç«¯ç›´æ¥è®¿é—® (port 3000)..."
        BACKEND_OK=false
        for i in {1..5}; do
          if curl -s -f $CURL_TIMEOUT http://115.190.252.62:3000/api/v1/auth/login \
            -X POST \
            -H "Content-Type: application/json" \
            -d '{"email":"test@test.com","password":"test123"}' > /dev/null 2>&1; then
            echo "âœ… åç«¯ç›´æ¥è®¿é—®æ­£å¸¸"
            BACKEND_OK=true
            break
          else
            if [ $i -lt 5 ]; then
              echo "â³ åç«¯å¯åŠ¨ä¸­... ($i/5)"
              sleep 3
            else
              echo "âš ï¸ åç«¯å¯èƒ½è¿˜åœ¨å¯åŠ¨æˆ–éœ€è¦æ›´å¤šæ—¶é—´"
            fi
          fi
        done

        # æ£€æŸ¥å‰ç«¯ï¼ˆç®€åŒ–ä¸ºåªæ£€æŸ¥æ˜¯å¦è¿”å›200ï¼‰
        echo "ğŸ“Œ æ£€æŸ¥å‰ç«¯è®¿é—®..."
        if curl -s -f $CURL_TIMEOUT http://115.190.252.62/ > /dev/null 2>&1; then
          echo "âœ… å‰ç«¯å¯è®¿é—®"
        else
          echo "âš ï¸ å‰ç«¯æœªå°±ç»ªï¼ˆNginxå¯èƒ½éœ€è¦é…ç½®æˆ–å‰ç«¯æœªæ„å»ºï¼‰"
        fi

        # éªŒè¯å…³é”® API æ¥å£ï¼ˆå¦‚æœæœ‰ tokenï¼‰
        if [ -n "$TEST_TOKEN" ] && [ "$BACKEND_OK" = true ]; then
          echo "ğŸ“Œ éªŒè¯å…³é”® API æ¥å£..."

          # ç®€åŒ–æ£€æŸ¥ï¼Œåªæµ‹è¯•æœ€æ ¸å¿ƒçš„æ¥å£
          ENDPOINTS=(
            "/api/v1/messages/unread-count"
            "/api/v1/messages/conversations?page=1&limit=10"
          )

          for endpoint in "${ENDPOINTS[@]}"; do
            echo "æ£€æŸ¥ $endpoint..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $CURL_TIMEOUT \
              "http://115.190.252.62$endpoint" \
              -H "Authorization: Bearer $TEST_TOKEN" || echo "000")

            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
              echo "âœ… $endpoint OK (HTTP $HTTP_CODE)"
            else
              echo "âš ï¸ $endpoint è¿”å› HTTP $HTTP_CODE"
            fi
          done
        fi

        echo "ğŸ å¥åº·æ£€æŸ¥å®Œæˆï¼ˆéé˜»å¡ï¼‰"

    - name: Notify status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "âœ… å‰ç«¯: http://115.190.252.62"
          echo "âœ… åç«¯ API: http://115.190.252.62:3000/api/v1"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥"
          echo "è¯·æ£€æŸ¥ä¸Šé¢çš„é”™è¯¯æ—¥å¿—"
        fi

    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
        echo "å¤±è´¥çš„æ­¥éª¤çŠ¶æ€: ${{ job.status }}"
