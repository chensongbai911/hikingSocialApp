# 徒步社交 APP vNext 迭代需求文档（PRD）
日期：2026-01-18  
作者：@wdhcnkmjxh-prog（需求发起）  
版本：vNext（目标：显著超越同类户外产品）

---

## 0. 背景与目标

### 0.1 当前版本能力概述（已实现）
- 用户系统：注册/登录/资料/相册/偏好/登山等级
- 活动系统：创建/浏览/搜索/详情/参加取消/状态管理
- 社交：匹配推荐、聊天（Socket.io）、评价反馈、关注（部分）
- 发现：推荐活动/推荐用户/趋势数据

### 0.2 当前版本不足
- 路线专业能力不足：缺少路书、轨迹记录、离线、路况与风险、补给点等
- 户外“过程体验”弱：出发前准备、途中协同、到达后复盘与分享缺少系统化闭环
- 安全体系缺失：紧急求助、自动触发、队伍互保、风险感知不足

### 0.3 vNext 产品定位（一句话）
以“路线”为核心的 **智能路书 + 队伍协同 + 安全闭环** 户外系统：  
让用户在路线前/中/后全流程获得“省心、安心、成就感”的爽点体验。

### 0.4 vNext 成功指标（KPI/北极星）
- 北极星：每周完成一次「路线计划 → 出发执行 → 复盘分享」闭环的用户数（WAC：Weekly Active Completion）
- 转化：路线计划创建→实际出发比例 ≥ 25%
- 留存：完成闭环用户 7 日留存 ≥ 35%
- 安全：紧急事件响应链路可用性 ≥ 99.5%，误触发率可控（< 2%）
- 内容传播：复盘卡片分享后带来新注册占比 ≥ 10%

---

## 1. 用户与场景

### 1.1 目标用户
1) 新手轻徒步用户：需要路线推荐、装备清单、风险提醒、带队人  
2) 进阶徒步用户：需要爬升/配速/轨迹/离线、路况与补给点、队伍协同  
3) 领队/组织者：需要队员管理、集合签到、行程节奏、风险控制、复盘沉淀

### 1.2 核心场景（路线前-中-后）
- 前：选线 → 看风险 → 规划时间与体力 → 装备与补给准备 → 组队招募
- 中：导航与轨迹 → 队伍位置协同 → 关键点提醒 → 状态上报 → 紧急救援
- 后：自动生成复盘报告 → 评分与建议 → 路线沉淀 → 一键分享“战报卡片”

---

## 2. vNext 功能总览（按优先级）

### P0（必须做，形成差异化闭环）
1) 路书（Route Guide）与关键点系统（POI/Waypoints）
2) 轨迹记录与离线能力（基础离线：缓存路书/地图切片策略可后置）
3) 队伍协同：队伍房间 + 行进状态 + 位置共享（可控隐私）
4) 安全闭环：一键 SOS + 自动风险触发（失联/偏航/异常停止）
5) 复盘报告：自动生成“路线战报”与可分享卡片（结合 html2canvas）

### P1（增强体验，拉开与竞品差距）
6) 智能准备助手：装备/补给清单 + 个人化建议 + 出发前检查
7) 路线风险雷达：天气/地形/时段/人群密度/补给缺口综合评分（先用规则，后续可接外部数据）
8) 领队工具箱：集合签到、队员体力分层、节奏建议、分组协同
9) 路线“前中后”社交：同路线的人、关键点打卡留言、沿途照片串联成“路线故事”

### P2（高级增值与护城河）
10) AI 路线教练：基于历史轨迹 + 海拔爬升 + 体能，给出配速/休息/补水提醒
11) “隐私安全”与“可信救援”：联系人体系、共享范围、事后可追溯
12) 路线资产市场：公开/私密路书、领队路线包、组织者工具（商业化）

---

## 3. 详细需求（P0）

> 注：以下为 vNext 首发范围。每条均包含：目标、用户流程、功能点、验收标准、数据字段建议。

### 3.1 路书（Route Guide）+ 关键点（Waypoints/POI）
**目标**：让用户在“路线前”就形成清晰预期，在“路线中”被关键点引导，在“路线后”可沉淀与复用。

**用户流程**
- 创建/导入路线 → 编辑关键点 → 发布为活动路线或个人收藏路线 → 出发时使用路书导航/提醒

**功能点**
- 路线基础信息：名称、封面、里程、累计爬升、预计用时、难度、适合季节、注意事项
- 关键点类型：
  - 集合点/起点/终点
  - 观景点
  - 补给点（商店/水源）
  - 风险点（陡坡/崖边/涉水/迷路高发）
  - 休息点/撤退点（紧急下撤路线提示）
- 关键点字段：经纬度、海拔（可选）、描述、图片、建议停留时长、风险标签
- 路书支持绑定活动（活动发布时可选择路线）

**验收标准**
- 可创建路线并添加 ≥ 1 个关键点
- 活动详情页可展示路线摘要与关键点列表
- 行进中能按距离/到达触发关键点提醒（先实现距离阈值）

**数据结构建议**
- routes：id, creator_id, title, cover_url, distance_km, elevation_gain_m, duration_min, difficulty, season_tags, notes, visibility(public/private), created_at
- route_waypoints：id, route_id, type, lat, lng, name, description, stay_min, risk_tags(json), images(json), order_index

---

### 3.2 轨迹记录（Track Recording）
**目标**：让用户“路线中”有记录，“路线后”有复盘资产；形成用户长期沉淀。

**用户流程**
- 出发 → 开始记录 → 暂停/继续 → 结束 → 自动生成轨迹与统计

**功能点**
- 记录点：时间戳、经纬度、速度（可选）、海拔（可选）
- 统计：总里程、移动时间、总耗时、平均配速、最高海拔（可选）
- 轨迹与路线对比：偏航提示（先做简单：与路线关键点/路径距离超阈值）
- 轨迹可关联活动（参与某活动则自动关联）

**验收标准**
- 能开始/结束记录，生成轨迹数据与基础统计
- 轨迹可在“我的徒步/活动复盘”里查看

**数据结构建议**
- tracks：id, user_id, activity_id(nullable), route_id(nullable), start_time, end_time, distance_km, moving_time_sec, duration_sec, avg_pace, created_at
- track_points：id, track_id, ts, lat, lng, alt(nullable), speed(nullable)

---

### 3.3 队伍协同（Team Hike Room）
**目标**：让“组队徒步”在途中更爽：看得到、叫得到、能协同。

**用户流程**
- 活动开始 → 自动创建队伍房间 → 队员进入 → 开启共享 → 行进中互看状态/位置 → 结束自动归档

**功能点**
- 队伍房间（活动维度）：成员列表、领队标识、实时消息
- 位置共享（用户可控开关）：
  - 共享给：仅领队 / 全队 / 仅好友 / 关闭
  - 更新频率：省电/标准/高频（先规则化，不做复杂自适应）
- 行进状态一键上报：
  - 我OK / 需要休息 / 受伤 / 掉队 / 到达关键点
- 领队视角：
  - 队员相对位置列表（距离领队、最后上报时间）
  - 一键提醒：集合/减速/补水/返程

**验收标准**
- 活动参与者进入同一房间，能看到成员在线/状态
- 能开启/关闭位置共享，并能显示“最后更新时间”
- 领队可发起“全队提醒”消息（Socket.io）

**数据结构建议**
- team_rooms：id, activity_id, status(active/archived)
- team_location_shares：user_id, activity_id, share_mode, last_ts, last_lat, last_lng
- team_status_reports：id, activity_id, user_id, status, note, ts

---

### 3.4 安全闭环（SOS + 自动风险触发）
**目标**：户外产品的护城河之一。做成“真能用”的安全体系。

**功能点**
1) 一键 SOS
- 触发后：
  - 向队伍房间广播“紧急”消息
  - 向预设紧急联系人发送信息（先做站内消息/短信接口预留）
  - 生成“救援卡片”：位置、时间、路线、队伍信息、个人资料（血型/过敏史可后续）
2) 自动风险触发（P0 先做规则版）
- 失联：用户位置共享开启但超过 X 分钟无更新
- 异常停止：移动速度持续过低且持续时间超过阈值
- 偏航：与路线/关键点距离超过阈值（例如 > 300m 且持续 5 分钟）

**验收标准**
- 能触发 SOS 并在队伍房间即时可见
- 能生成并展示“救援卡片”（前端可分享/截图）
- 自动触发至少覆盖“失联”一种场景，并有可配置阈值

**数据结构建议**
- emergency_contacts：id, user_id, name, phone, relationship, created_at
- sos_events：id, user_id, activity_id, route_id, lat, lng, ts, type(manual/auto), reason, status(open/closed)
- safety_settings：user_id, offline_minutes_threshold, stop_minutes_threshold, offroute_distance_threshold_m

---

### 3.5 复盘报告（After Action Report, AAR）+ 分享战报卡
**目标**：形成“到达后的爽点”和传播点，提高留存与拉新。

**功能点**
- 自动生成复盘：
  - 本次路线：里程/爬升/用时/配速
  - 关键点打卡（到达时间）
  - 风险事件（如偏航、SOS）
  - 照片串联（活动/个人上传）
- 一键生成分享卡（图片）：
  - 样式：路线名 + 数据四宫格 + 轨迹缩略图 + 勋章文案
  - 输出：保存/分享（Web 版先下载图片即可）
- 复盘可写“感受/建议”，沉淀为路线评价

**验收标准**
- 结束轨迹后自动创建复盘记录
- 复盘页可生成并导出分享图（利用 html2canvas）

**数据结构建议**
- hike_reports：id, user_id, activity_id, track_id, route_id, summary(json), note(text), created_at
- route_reviews：id, route_id, user_id, rating, tags(json), content, created_at

---

## 4. P1 功能（增强差异化）

### 4.1 智能准备助手（装备/补给清单）
- 基于路线难度/天气/时长生成清单
- 用户可勾选确认“出发检查”
- 个性化：根据用户等级、以往复盘“缺水/太冷”等记录调整建议

### 4.2 路线风险雷达（规则评分）
- 维度：夜行风险、补给缺口、海拔爬升强度、撤退难度、信号/失联风险（先用经验规则）
- 输出：风险等级 + 建议（例如“建议2人以上”“建议带头灯”）

### 4.3 领队工具箱
- 集合签到（到达集合点自动/手动）
- 队员体力分层（快/中/慢），领队可建议分组
- 返程提醒与节奏建议

---

## 5. 非功能需求（必须写清）
### 5.1 性能与稳定性
- 位置更新与轨迹记录需省电：提供省电模式
- Socket 断线重连：房间状态可恢复
- 数据丢失保护：轨迹点本地缓存，网络恢复后补传（可先做简化）

### 5.2 隐私与合规
- 位置共享必须默认关闭，且“范围可控”
- SOS 数据可追溯与权限控制
- 账号与个人敏感信息（紧急联系人）加密/脱敏展示

### 5.3 安全
- JWT 鉴权全链路覆盖
- 图片上传校验（类型/大小），Sharp 压缩处理
- 风险触发阈值可配置，避免大量误报

---

## 6. 里程碑与交付计划（建议 4 个 Sprint）
### Sprint 1（路线与路书）
- routes / waypoints 数据模型与 CRUD
- 活动绑定路线 + 前端展示
- 基础关键点提醒（按距离）

### Sprint 2（轨迹记录 + 复盘）
- tracks / track_points 上报与存储
- 复盘页 + 分享战报卡（html2canvas）
- 我的徒步：轨迹列表、复盘入口

### Sprint 3（队伍协同）
- team room（Socket.io）+ 位置共享 + 状态上报
- 领队视角（成员距离/最后更新）
- 全队提醒

### Sprint 4（安全闭环）
- SOS 手动触发 + 救援卡
- 自动失联触发（规则版）
- 隐私设置与阈值设置

---

## 7. 验收清单（vNext 上线门槛）
- [ ] 可创建路线并在活动详情展示
- [ ] 可记录轨迹并生成复盘报告
- [ ] 队伍房间可用，消息稳定
- [ ] 位置共享可控且能展示更新时间
- [ ] SOS 可触发并生成救援卡
- [ ] 至少一种自动风险触发可用（失联）
- [ ] 分享战报卡可导出图片
- [ ] 隐私开关与权限控制明确可测

---

## 8. 开放问题（需要你拍板）
1) 路线数据来源：用户手动创建 / 导入 GPX / 平台精选（首发建议：手动+简化导入占位）
2) 地图服务：使用哪家地图 SDK/瓦片服务（Web 先用简单地图或静态图占位）
3) SOS 外联：短信/电话/第三方救援接口是否接入（首发建议：站内 + 联系人信息预留）
4) 商业化方向：路线包/领队工具/会员（可后续 P2）

---
结束