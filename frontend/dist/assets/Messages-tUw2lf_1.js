import{k as q,J as H,E as P,r as g,d as w,l as W,W as F,v as c,q as v,z as a,x as f,A as h,L as J,M as Q,O as D,P as U,S as G}from"./vue-Dq4PaVdn.js";import{u as K,s as A,g as X,t as Y,c as Z}from"./index-Bhs_HTB-.js";import"./state-COm4LJOs.js";const ee={class:"min-h-screen bg-gray-50"},te={class:"sticky-header bg-white p-4 border-b border-gray-100"},se={class:"flex items-center justify-between mb-4"},ne={key:0,class:"text-xs px-2 py-1 bg-red-100 text-red-600 rounded-full"},oe={class:"relative"},ae={class:"flex justify-end mt-2 space-x-2 text-sm"},re={key:0,class:"p-4 space-y-3"},le=["onClick"],ie={class:"relative flex-shrink-0"},ue=["src","alt"],de={key:0,class:"absolute bottom-0 right-0 w-4 h-4 bg-green-500 border-2 border-white rounded-full"},ce={class:"ml-4 flex-1 min-w-0"},ve={class:"flex items-center justify-between mb-1"},ge={class:"font-medium text-gray-800 truncate"},me={class:"text-sm text-gray-400 flex-shrink-0"},fe={class:"text-sm text-gray-500 truncate"},pe={key:0,class:"ml-3 flex-shrink-0 w-6 h-6 bg-red-500 text-white text-xs font-medium rounded-full flex items-center justify-center"},he={key:1,class:"py-20 text-center text-gray-400"},xe={key:2,class:"py-12 text-center text-gray-400"},ye="https://placehold.co/120x120",be=q({__name:"Messages",setup(_e){const L=(s,e=600)=>{let n=0;return(...t)=>{const l=Date.now();l-n>e&&(n=l,s(...t))}},O=H(),j=P(),C=K(),x=g(""),m=g(!1),y=g(!1),M=g(1),B=g(20),b=g(0),r=g([]),T=w(()=>r.value.reduce((s,e)=>s+(e.unreadCount||0),0)),N=s=>{if(!s)return"";const e=new Date(s),t=new Date().getTime()-e.getTime();return t<6e4?"刚刚":t<36e5?`${Math.floor(t/6e4)}分钟前`:t<864e5?`${Math.floor(t/36e5)}小时前`:e.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})},z=s=>{const e=String(C.userId);console.log("[Messages mapConversation] 当前用户ID:",e,"原始数据:",{userId1:s.userId1,userId2:s.userId2});const n=String(s.userId1)===e,t=n?s.user2:s.user1,l=n?s.user1UnreadCount:s.user2UnreadCount,u=(t==null?void 0:t.nickname)||(t==null?void 0:t.name)||"陌生人",d=(t==null?void 0:t.avatarUrl)||(t==null?void 0:t.avatar_url)||"",o=s.lastMessageContent||"",i=t!=null&&t.id?String(t.id):void 0;return console.log("[Messages] 映射对话:",{conversationId:s.id,otherUserId:i,otherName:u,otherAvatar:d,lastMessage:o,unread:l}),{id:String(s.id),name:u,avatar:d,lastMessage:o,lastTime:s.lastMessageAt||s.updatedAt||s.createdAt||null,unreadCount:l||0,isOnline:!1,otherUserId:i}},_=async(s=!0)=>{var e,n;if(C.isLoggedIn){s&&(M.value=1,r.value=[]),s?m.value=!0:y.value=!0;try{const t=await X(M.value,B.value);console.log("[Messages] getConversations 原始响应:",t);const l=(t==null?void 0:t.conversations)||((e=t==null?void 0:t.data)==null?void 0:e.conversations)||[],u=new Map;b.value=(t==null?void 0:t.total)??((n=t==null?void 0:t.data)==null?void 0:n.total)??l.length,console.log("[Messages] 原始对话数:",l.length,"列表:",l),l.map(z).forEach(o=>{const i=`c_${o.id}`,p=u.get(i);(!p||o.lastTime&&p.lastTime&&new Date(o.lastTime)>new Date(p.lastTime))&&(u.set(i,o),console.log("[Messages] 添加对话:",{id:o.id,name:o.name,lastTime:o.lastTime}))});const d=Array.from(u.values());console.log("[Messages] 映射后对话数:",d.length,"对话列表:",d.map(o=>({id:o.id,name:o.name,lastMessage:o.lastMessage}))),r.value=s?d:[...r.value,...d].sort((o,i)=>(i.lastTime?new Date(i.lastTime).getTime():0)-(o.lastTime?new Date(o.lastTime).getTime():0)),console.log("[Messages] 最终对话列表:",r.value.map(o=>({id:o.id,name:o.name}))),l.length>0&&(M.value+=1)}catch(t){console.error("[Messages] 加载对话列表失败:",t),Y.error((t==null?void 0:t.message)||"加载会话失败")}finally{m.value=!1,y.value=!1}}},I=w(()=>{if(!x.value.trim())return r.value;const s=x.value.toLowerCase();return r.value.filter(e=>e.name.toLowerCase().includes(s)||(e.lastMessage||"").toLowerCase().includes(s))}),E=w(()=>r.value.length<(b.value||r.value.length)),R=L(()=>{y.value||_(!1)},500),S=s=>{r.value=r.value.map(e=>e.id===s.id?{...e,unreadCount:0}:e),Z(s.id).catch(()=>{}),O.push({name:"ChatWindow",params:{id:s.id},state:{from:"messages"}})},V=(s,e)=>{const n=r.value.findIndex(l=>l.id===s),t=n>=0;if(t){const l=r.value[n];r.value.splice(n,1,{...l,...e})}else r.value.unshift({id:s,name:e.name||"陌生人",avatar:e.avatar||"",lastMessage:e.lastMessage||"",lastTime:e.lastTime||new Date().toISOString(),unreadCount:e.unreadCount??1,isOnline:e.isOnline??!1,otherUserId:e.otherUserId});return r.value=[...r.value].sort((l,u)=>(u.lastTime?new Date(u.lastTime).getTime():0)-(l.lastTime?new Date(l.lastTime).getTime():0)),t},k=[],$=s=>{const e=s.target;if(!e)return;e.scrollHeight-e.scrollTop-e.clientHeight<120&&E.value&&!y.value&&R()};return W(async()=>{await _();const s=j.query.conversationId;s&&setTimeout(()=>{const e=r.value.find(n=>n.id===s);e&&S(e)},300),k.push(A.onMessageReceived(e=>{var d,o,i;const n=String(e.conversationId||e.conversation_id),t=e.senderId||e.sender_id,l=String(t)===String(C.userId);V(n,{lastMessage:((d=e.message)==null?void 0:d.content)||e.content||"[新消息]",lastTime:((o=e.message)==null?void 0:o.created_at)||e.createdAt||new Date().toISOString(),unreadCount:l?0:(((i=r.value.find(p=>p.id===n))==null?void 0:i.unreadCount)||0)+1,name:e.senderNickname||e.sender_nickname||void 0,avatar:e.senderAvatar||e.sender_avatar||void 0,otherUserId:t?String(t):void 0})||_()})),k.push(A.onOnlineStatusChange(e=>{const n=String(e.userId||e.id);r.value=r.value.map(t=>t.otherUserId===n?{...t,isOnline:e.type==="online"||e.status==="online"}:t)}))}),F(()=>{k.forEach(s=>s())}),(s,e)=>(v(),c("div",ee,[a("div",te,[a("div",se,[e[2]||(e[2]=a("h1",{class:"text-2xl font-bold text-gray-800"},"消息中心",-1)),T.value>0?(v(),c("span",ne,"未读 "+h(T.value),1)):f("",!0)]),a("div",oe,[J(a("input",{"onUpdate:modelValue":e[0]||(e[0]=n=>x.value=n),type:"text",placeholder:"搜索联系人或聊天记录",class:"w-full pl-12 pr-4 py-3 bg-gray-50 rounded-2xl focus:outline-none focus:ring-2 focus:ring-teal-500"},null,512),[[Q,x.value]]),e[3]||(e[3]=a("svg",{class:"w-6 h-6 text-teal-500 absolute left-4 top-1/2 -translate-y-1/2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1))]),a("div",ae,[a("button",{class:"px-3 py-1 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200",onClick:e[1]||(e[1]=()=>{m.value||_(!0)})}," 刷新 ")])]),e[6]||(e[6]=a("div",{class:"px-4 py-2"},[a("h2",{class:"text-lg font-bold text-teal-600"},"最近私聊")],-1)),a("div",{class:"bg-white flex-1 overflow-y-auto",onScrollPassive:$},[m.value&&r.value.length===0?(v(),c("div",re,[(v(),c(D,null,U(6,n=>a("div",{key:n,class:"flex items-center animate-pulse space-x-4"},[...e[4]||(e[4]=[G('<div class="w-14 h-14 bg-gray-200 rounded-full"></div><div class="flex-1 space-y-2"><div class="h-4 bg-gray-200 rounded w-1/3"></div><div class="h-3 bg-gray-100 rounded w-2/3"></div></div><div class="w-8 h-4 bg-gray-100 rounded"></div>',3)])])),64))])):f("",!0),(v(!0),c(D,null,U(I.value,n=>(v(),c("div",{key:n.id,onClick:t=>S(n),class:"flex items-center p-4 border-b border-gray-100 active:bg-gray-50 cursor-pointer"},[a("div",ie,[a("img",{src:n.avatar||ye,alt:n.name,class:"w-14 h-14 rounded-full object-cover"},null,8,ue),n.isOnline?(v(),c("div",de)):f("",!0)]),a("div",ce,[a("div",ve,[a("h3",ge,h(n.name||"陌生人"),1),a("span",me,h(N(n.lastTime)),1)]),a("p",fe,h(n.lastMessage||"暂无消息"),1)]),n.unreadCount>0?(v(),c("div",pe,h(n.unreadCount>9?"9+":n.unreadCount),1)):f("",!0)],8,le))),128)),!m.value&&I.value.length===0?(v(),c("div",he,[...e[5]||(e[5]=[a("svg",{class:"w-20 h-20 mx-auto mb-4 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})],-1),a("p",null,"暂无聊天记录",-1)])])):f("",!0),m.value?(v(),c("div",xe,"加载中...")):f("",!0)],32)]))}});export{be as default};
