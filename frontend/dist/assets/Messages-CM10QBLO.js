import{k as q,J as H,E as P,r as c,d as b,l as W,W as F,v as i,q as u,z as o,x as f,A as p,L as J,M as Q,O as U,P as D,S as G}from"./vue-Dq4PaVdn.js";import{u as K,s as L,g as X,t as Y,c as Z}from"./index-SPuOt1So.js";import"./state-COm4LJOs.js";const ee={class:"min-h-screen bg-gray-50"},te={class:"bg-white p-4 sticky top-0 z-10"},se={class:"flex items-center justify-between mb-4"},ne={key:0,class:"text-xs px-2 py-1 bg-red-100 text-red-600 rounded-full"},oe={class:"relative"},ae={class:"flex justify-end mt-2 space-x-2 text-sm"},re={key:0,class:"p-4 space-y-3"},le=["onClick"],ie={class:"relative flex-shrink-0"},ue=["src","alt"],de={key:0,class:"absolute bottom-0 right-0 w-4 h-4 bg-green-500 border-2 border-white rounded-full"},ce={class:"ml-4 flex-1 min-w-0"},ve={class:"flex items-center justify-between mb-1"},ge={class:"font-medium text-gray-800 truncate"},me={class:"text-sm text-gray-400 flex-shrink-0"},fe={class:"text-sm text-gray-500 truncate"},pe={key:0,class:"ml-3 flex-shrink-0 w-6 h-6 bg-red-500 text-white text-xs font-medium rounded-full flex items-center justify-center"},he={key:1,class:"py-20 text-center text-gray-400"},xe={key:2,class:"py-12 text-center text-gray-400"},ye="https://placehold.co/120x120",be=q({__name:"Messages",setup(_e){const O=(s,e=600)=>{let t=0;return(...n)=>{const r=Date.now();r-t>e&&(t=r,s(...n))}},A=H(),j=P(),_=K(),h=c(""),v=c(!1),x=c(!1),w=c(1),B=c(20),k=c(0),a=c([]),T=b(()=>a.value.reduce((s,e)=>s+(e.unreadCount||0),0)),z=s=>{if(!s)return"";const e=new Date(s),n=new Date().getTime()-e.getTime();return n<6e4?"刚刚":n<36e5?`${Math.floor(n/6e4)}分钟前`:n<864e5?`${Math.floor(n/36e5)}小时前`:e.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})},N=s=>{const e=String(_.userId),t=String(s.userId1)===e?s.user2:s.user1,n=String(s.userId1)===e?s.user2UnreadCount:s.user1UnreadCount,r=s.lastMessageContent||"";return{id:String(s.id),name:(t==null?void 0:t.nickname)||"陌生人",avatar:(t==null?void 0:t.avatarUrl)||"",lastMessage:r,lastTime:s.lastMessageAt||s.updatedAt||s.createdAt||null,unreadCount:n||0,isOnline:!1,otherUserId:t!=null&&t.id?String(t.id):void 0}},y=async(s=!0)=>{var e;if(_.isLoggedIn){s&&(w.value=1,a.value=[]),s?v.value=!0:x.value=!0;try{const t=await X(w.value,B.value),n=(t==null?void 0:t.conversations)||t||[],r=new Map;k.value=(t==null?void 0:t.total)??((e=t==null?void 0:t.data)==null?void 0:e.total)??k.value,n.map(N).forEach(l=>{const d=l.otherUserId?`u_${l.otherUserId}`:`c_${l.id}`,m=r.get(d);(!m||l.lastTime&&m.lastTime&&new Date(l.lastTime)>new Date(m.lastTime))&&r.set(d,l)});const g=Array.from(r.values());a.value=s?g:[...a.value,...g].sort((l,d)=>(d.lastTime?new Date(d.lastTime).getTime():0)-(l.lastTime?new Date(l.lastTime).getTime():0)),n.length>0&&(w.value+=1)}catch(t){Y.error((t==null?void 0:t.message)||"加载会话失败")}finally{v.value=!1,x.value=!1}}},S=b(()=>{if(!h.value.trim())return a.value;const s=h.value.toLowerCase();return a.value.filter(e=>e.name.toLowerCase().includes(s)||(e.lastMessage||"").toLowerCase().includes(s))}),$=b(()=>a.value.length<(k.value||a.value.length)),E=O(()=>{x.value||y(!1)},500),M=s=>{a.value=a.value.map(e=>e.id===s.id?{...e,unreadCount:0}:e),Z(s.id).catch(()=>{}),A.push({name:"ChatWindow",params:{id:s.id},state:{from:"messages"}})},R=(s,e)=>{const t=a.value.findIndex(r=>r.id===s),n=t>=0;if(n){const r=a.value[t];a.value.splice(t,1,{...r,...e})}else a.value.unshift({id:s,name:e.name||"陌生人",avatar:e.avatar||"",lastMessage:e.lastMessage||"",lastTime:e.lastTime||new Date().toISOString(),unreadCount:e.unreadCount??1,isOnline:e.isOnline??!1,otherUserId:e.otherUserId});return a.value=[...a.value].sort((r,g)=>(g.lastTime?new Date(g.lastTime).getTime():0)-(r.lastTime?new Date(r.lastTime).getTime():0)),n},C=[],V=s=>{const e=s.target;if(!e)return;e.scrollHeight-e.scrollTop-e.clientHeight<120&&$.value&&!x.value&&E()};return W(async()=>{await y();const s=j.query.conversationId;s&&setTimeout(()=>{const e=a.value.find(t=>t.id===s);e&&M(e)},300),C.push(L.onMessageReceived(e=>{var l,d,m;const t=String(e.conversationId||e.conversation_id),n=e.senderId||e.sender_id,r=String(n)===String(_.userId);R(t,{lastMessage:((l=e.message)==null?void 0:l.content)||e.content||"[新消息]",lastTime:((d=e.message)==null?void 0:d.created_at)||e.createdAt||new Date().toISOString(),unreadCount:r?0:(((m=a.value.find(I=>I.id===t))==null?void 0:m.unreadCount)||0)+1,name:e.senderNickname||e.sender_nickname||void 0,avatar:e.senderAvatar||e.sender_avatar||void 0,otherUserId:n?String(n):void 0})||y()})),C.push(L.onOnlineStatusChange(e=>{const t=String(e.userId||e.id);a.value=a.value.map(n=>n.otherUserId===t?{...n,isOnline:e.type==="online"||e.status==="online"}:n)}))}),F(()=>{C.forEach(s=>s())}),(s,e)=>(u(),i("div",ee,[o("div",te,[o("div",se,[e[2]||(e[2]=o("h1",{class:"text-2xl font-bold text-gray-800"},"消息中心",-1)),T.value>0?(u(),i("span",ne,"未读 "+p(T.value),1)):f("",!0)]),o("div",oe,[J(o("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>h.value=t),type:"text",placeholder:"搜索联系人或聊天记录",class:"w-full pl-12 pr-4 py-3 bg-gray-50 rounded-2xl focus:outline-none focus:ring-2 focus:ring-teal-500"},null,512),[[Q,h.value]]),e[3]||(e[3]=o("svg",{class:"w-6 h-6 text-teal-500 absolute left-4 top-1/2 -translate-y-1/2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1))]),o("div",ae,[o("button",{class:"px-3 py-1 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200",onClick:e[1]||(e[1]=()=>{v.value||y(!0)})}," 刷新 ")])]),e[6]||(e[6]=o("div",{class:"px-4 py-2"},[o("h2",{class:"text-lg font-bold text-teal-600"},"最近私聊")],-1)),o("div",{class:"bg-white flex-1 overflow-y-auto",onScrollPassive:V},[v.value&&a.value.length===0?(u(),i("div",re,[(u(),i(U,null,D(6,t=>o("div",{key:t,class:"flex items-center animate-pulse space-x-4"},[...e[4]||(e[4]=[G('<div class="w-14 h-14 bg-gray-200 rounded-full"></div><div class="flex-1 space-y-2"><div class="h-4 bg-gray-200 rounded w-1/3"></div><div class="h-3 bg-gray-100 rounded w-2/3"></div></div><div class="w-8 h-4 bg-gray-100 rounded"></div>',3)])])),64))])):f("",!0),(u(!0),i(U,null,D(S.value,t=>(u(),i("div",{key:t.id,onClick:n=>M(t),class:"flex items-center p-4 border-b border-gray-100 active:bg-gray-50 cursor-pointer"},[o("div",ie,[o("img",{src:t.avatar||ye,alt:t.name,class:"w-14 h-14 rounded-full object-cover"},null,8,ue),t.isOnline?(u(),i("div",de)):f("",!0)]),o("div",ce,[o("div",ve,[o("h3",ge,p(t.name||"陌生人"),1),o("span",me,p(z(t.lastTime)),1)]),o("p",fe,p(t.lastMessage||"暂无消息"),1)]),t.unreadCount>0?(u(),i("div",pe,p(t.unreadCount>9?"9+":t.unreadCount),1)):f("",!0)],8,le))),128)),!v.value&&S.value.length===0?(u(),i("div",he,[...e[5]||(e[5]=[o("svg",{class:"w-20 h-20 mx-auto mb-4 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})],-1),o("p",null,"暂无聊天记录",-1)])])):f("",!0),v.value?(u(),i("div",xe,"加载中...")):f("",!0)],32)]))}});export{be as default};
