import{k as q,J as P,E as H,r as g,d as M,l as W,W as F,v as d,q as c,z as o,x as f,A as p,L as J,M as Q,O as U,P as D,S as G}from"./vue-Dq4PaVdn.js";import{u as K,s as A,g as X,t as Y,c as Z}from"./index-wS4y3d_1.js";import"./state-COm4LJOs.js";const ee={class:"min-h-screen bg-gray-50"},te={class:"bg-white p-4 sticky top-0 z-10"},se={class:"flex items-center justify-between mb-4"},ne={key:0,class:"text-xs px-2 py-1 bg-red-100 text-red-600 rounded-full"},oe={class:"relative"},ae={class:"flex justify-end mt-2 space-x-2 text-sm"},re={key:0,class:"p-4 space-y-3"},le=["onClick"],ie={class:"relative flex-shrink-0"},ue=["src","alt"],de={key:0,class:"absolute bottom-0 right-0 w-4 h-4 bg-green-500 border-2 border-white rounded-full"},ce={class:"ml-4 flex-1 min-w-0"},ve={class:"flex items-center justify-between mb-1"},ge={class:"font-medium text-gray-800 truncate"},me={class:"text-sm text-gray-400 flex-shrink-0"},fe={class:"text-sm text-gray-500 truncate"},he={key:0,class:"ml-3 flex-shrink-0 w-6 h-6 bg-red-500 text-white text-xs font-medium rounded-full flex items-center justify-center"},pe={key:1,class:"py-20 text-center text-gray-400"},xe={key:2,class:"py-12 text-center text-gray-400"},ye="https://placehold.co/120x120",Me=q({__name:"Messages",setup(_e){const L=(n,e=600)=>{let t=0;return(...s)=>{const r=Date.now();r-t>e&&(t=r,n(...s))}},O=P(),j=H(),w=K(),x=g(""),m=g(!1),y=g(!1),k=g(1),B=g(20),C=g(0),a=g([]),T=M(()=>a.value.reduce((n,e)=>n+(e.unreadCount||0),0)),z=n=>{if(!n)return"";const e=new Date(n),s=new Date().getTime()-e.getTime();return s<6e4?"刚刚":s<36e5?`${Math.floor(s/6e4)}分钟前`:s<864e5?`${Math.floor(s/36e5)}小时前`:e.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})},N=n=>{const e=String(w.userId),t=String(n.userId1)===e?n.user2:n.user1,s=String(n.userId1)===e?n.user2UnreadCount:n.user1UnreadCount,r=(t==null?void 0:t.nickname)||(t==null?void 0:t.name)||"陌生人",i=(t==null?void 0:t.avatarUrl)||(t==null?void 0:t.avatar_url)||"",u=n.lastMessageContent||"";return console.log("[Messages] 映射对话:",{conversationId:n.id,otherUser:t,otherName:r,otherAvatar:i,lastMessage:u,unread:s}),{id:String(n.id),name:r,avatar:i,lastMessage:u,lastTime:n.lastMessageAt||n.updatedAt||n.createdAt||null,unreadCount:s||0,isOnline:!1,otherUserId:t!=null&&t.id?String(t.id):void 0}},_=async(n=!0)=>{var e,t;if(w.isLoggedIn){n&&(k.value=1,a.value=[]),n?m.value=!0:y.value=!0;try{const s=await X(k.value,B.value);console.log("[Messages] 获取对话列表响应:",s);const r=(s==null?void 0:s.conversations)||((e=s==null?void 0:s.data)==null?void 0:e.conversations)||s||[],i=new Map;C.value=(s==null?void 0:s.total)??((t=s==null?void 0:s.data)==null?void 0:t.total)??(s==null?void 0:s.totalPages)??C.value,console.log("[Messages] 原始对话数:",r.length,"列表:",r),r.map(N).forEach(l=>{const v=l.otherUserId?`u_${l.otherUserId}`:`c_${l.id}`,h=i.get(v);(!h||l.lastTime&&h.lastTime&&new Date(l.lastTime)>new Date(h.lastTime))&&i.set(v,l)});const u=Array.from(i.values());console.log("[Messages] 映射后对话数:",u.length,"列表:",u),a.value=n?u:[...a.value,...u].sort((l,v)=>(v.lastTime?new Date(v.lastTime).getTime():0)-(l.lastTime?new Date(l.lastTime).getTime():0)),r.length>0&&(k.value+=1)}catch(s){console.error("[Messages] 加载对话列表失败:",s),Y.error((s==null?void 0:s.message)||"加载会话失败")}finally{m.value=!1,y.value=!1}}},S=M(()=>{if(!x.value.trim())return a.value;const n=x.value.toLowerCase();return a.value.filter(e=>e.name.toLowerCase().includes(n)||(e.lastMessage||"").toLowerCase().includes(n))}),$=M(()=>a.value.length<(C.value||a.value.length)),E=L(()=>{y.value||_(!1)},500),I=n=>{a.value=a.value.map(e=>e.id===n.id?{...e,unreadCount:0}:e),Z(n.id).catch(()=>{}),O.push({name:"ChatWindow",params:{id:n.id},state:{from:"messages"}})},R=(n,e)=>{const t=a.value.findIndex(r=>r.id===n),s=t>=0;if(s){const r=a.value[t];a.value.splice(t,1,{...r,...e})}else a.value.unshift({id:n,name:e.name||"陌生人",avatar:e.avatar||"",lastMessage:e.lastMessage||"",lastTime:e.lastTime||new Date().toISOString(),unreadCount:e.unreadCount??1,isOnline:e.isOnline??!1,otherUserId:e.otherUserId});return a.value=[...a.value].sort((r,i)=>(i.lastTime?new Date(i.lastTime).getTime():0)-(r.lastTime?new Date(r.lastTime).getTime():0)),s},b=[],V=n=>{const e=n.target;if(!e)return;e.scrollHeight-e.scrollTop-e.clientHeight<120&&$.value&&!y.value&&E()};return W(async()=>{await _();const n=j.query.conversationId;n&&setTimeout(()=>{const e=a.value.find(t=>t.id===n);e&&I(e)},300),b.push(A.onMessageReceived(e=>{var u,l,v;const t=String(e.conversationId||e.conversation_id),s=e.senderId||e.sender_id,r=String(s)===String(w.userId);R(t,{lastMessage:((u=e.message)==null?void 0:u.content)||e.content||"[新消息]",lastTime:((l=e.message)==null?void 0:l.created_at)||e.createdAt||new Date().toISOString(),unreadCount:r?0:(((v=a.value.find(h=>h.id===t))==null?void 0:v.unreadCount)||0)+1,name:e.senderNickname||e.sender_nickname||void 0,avatar:e.senderAvatar||e.sender_avatar||void 0,otherUserId:s?String(s):void 0})||_()})),b.push(A.onOnlineStatusChange(e=>{const t=String(e.userId||e.id);a.value=a.value.map(s=>s.otherUserId===t?{...s,isOnline:e.type==="online"||e.status==="online"}:s)}))}),F(()=>{b.forEach(n=>n())}),(n,e)=>(c(),d("div",ee,[o("div",te,[o("div",se,[e[2]||(e[2]=o("h1",{class:"text-2xl font-bold text-gray-800"},"消息中心",-1)),T.value>0?(c(),d("span",ne,"未读 "+p(T.value),1)):f("",!0)]),o("div",oe,[J(o("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>x.value=t),type:"text",placeholder:"搜索联系人或聊天记录",class:"w-full pl-12 pr-4 py-3 bg-gray-50 rounded-2xl focus:outline-none focus:ring-2 focus:ring-teal-500"},null,512),[[Q,x.value]]),e[3]||(e[3]=o("svg",{class:"w-6 h-6 text-teal-500 absolute left-4 top-1/2 -translate-y-1/2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1))]),o("div",ae,[o("button",{class:"px-3 py-1 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200",onClick:e[1]||(e[1]=()=>{m.value||_(!0)})}," 刷新 ")])]),e[6]||(e[6]=o("div",{class:"px-4 py-2"},[o("h2",{class:"text-lg font-bold text-teal-600"},"最近私聊")],-1)),o("div",{class:"bg-white flex-1 overflow-y-auto",onScrollPassive:V},[m.value&&a.value.length===0?(c(),d("div",re,[(c(),d(U,null,D(6,t=>o("div",{key:t,class:"flex items-center animate-pulse space-x-4"},[...e[4]||(e[4]=[G('<div class="w-14 h-14 bg-gray-200 rounded-full"></div><div class="flex-1 space-y-2"><div class="h-4 bg-gray-200 rounded w-1/3"></div><div class="h-3 bg-gray-100 rounded w-2/3"></div></div><div class="w-8 h-4 bg-gray-100 rounded"></div>',3)])])),64))])):f("",!0),(c(!0),d(U,null,D(S.value,t=>(c(),d("div",{key:t.id,onClick:s=>I(t),class:"flex items-center p-4 border-b border-gray-100 active:bg-gray-50 cursor-pointer"},[o("div",ie,[o("img",{src:t.avatar||ye,alt:t.name,class:"w-14 h-14 rounded-full object-cover"},null,8,ue),t.isOnline?(c(),d("div",de)):f("",!0)]),o("div",ce,[o("div",ve,[o("h3",ge,p(t.name||"陌生人"),1),o("span",me,p(z(t.lastTime)),1)]),o("p",fe,p(t.lastMessage||"暂无消息"),1)]),t.unreadCount>0?(c(),d("div",he,p(t.unreadCount>9?"9+":t.unreadCount),1)):f("",!0)],8,le))),128)),!m.value&&S.value.length===0?(c(),d("div",pe,[...e[5]||(e[5]=[o("svg",{class:"w-20 h-20 mx-auto mb-4 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})],-1),o("p",null,"暂无聊天记录",-1)])])):f("",!0),m.value?(c(),d("div",xe,"加载中...")):f("",!0)],32)]))}});export{Me as default};
