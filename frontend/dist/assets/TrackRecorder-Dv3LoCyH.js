var W=Object.defineProperty;var H=(s,t,e)=>t in s?W(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var m=(s,t,e)=>H(s,typeof t!="symbol"?t+"":t,e);import{r as p,d as D,k as K,J as q,l as J,W as j,v as u,q as v,z as a,A as f,G as A,O as R,P as x,U as Q,L as E,M as C,x as w}from"./vue-B6Xl8iL6.js";import{t as T}from"./track-BPHt_26C.js";import{r as X}from"./route-CMQZM-Sp.js";import{_ as Y}from"./index-D-ytOed8.js";import"./apiService-eCEBkkdb.js";import"./state-BRWMog1q.js";const F=()=>new Promise((s,t)=>{if(typeof AMap<"u"){s();return}const e=document.createElement("script"),n="b92a734708f227d392015c74eb075ac6";e.src=`https://webapi.amap.com/maps?v=2.0&key=${n}&plugin=AMap.Geolocation,AMap.Geocoder,AMap.Walking,AMap.Driving`,e.async=!0,e.onload=()=>s(),e.onerror=()=>t(new Error("Failed to load AMap SDK")),document.head.appendChild(e)}),Z=(s,t)=>F().then(()=>{const e={zoom:12,center:[116.4074,39.9042],viewMode:"3D",pitch:0};return new AMap.Map(s,{...e,...t})}),tt=()=>F().then(()=>new Promise((s,t)=>{new AMap.Geolocation({enableHighAccuracy:!0,timeout:1e4}).getCurrentPosition((n,i)=>{n==="complete"?s({lng:i.position.lng,lat:i.position.lat,accuracy:i.accuracy}):t(new Error("å®šä½å¤±è´¥"))})})),I=(s,t)=>{if(typeof AMap>"u")throw new Error("AMap SDK not loaded");const e=new AMap.LngLat(s.lng,s.lat),n=new AMap.LngLat(t.lng,t.lat);return e.distance(n)};let et=class{constructor(t){m(this,"watchId",null);m(this,"points",[]);m(this,"isRecording",!1);m(this,"isPaused",!1);m(this,"lastPoint",null);m(this,"startTime",null);m(this,"totalDistance",0);m(this,"totalDuration",0);m(this,"options",{minDistance:5,minInterval:3e3,onPointAdded:()=>{},onError:()=>{}});t&&(this.options={...this.options,...t})}start(){this.isRecording||(this.isRecording=!0,this.isPaused=!1,this.startTime=new Date,"geolocation"in navigator?this.watchId=navigator.geolocation.watchPosition(t=>{this.isPaused||this.addPoint(t)},t=>{this.options.onError(new Error(`å®šä½å¤±è´¥: ${t.message}`))},{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}):this.options.onError(new Error("æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½")))}pause(){this.isPaused=!0}resume(){this.isPaused=!1}stop(){this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.isRecording=!1,this.isPaused=!1}addPoint(t){const e={lng:t.coords.longitude,lat:t.coords.latitude,altitude:t.coords.altitude||void 0,accuracy:t.coords.accuracy,speed:t.coords.speed||void 0,heading:t.coords.heading||void 0,recordedAt:new Date(t.timestamp).toISOString()};if(this.shouldRecordPoint(e)){if(this.lastPoint){const n=I(this.lastPoint,e);this.totalDistance+=n}this.points.push(e),this.lastPoint=e,this.options.onPointAdded(e)}}shouldRecordPoint(t){if(!this.lastPoint)return!0;if(I(this.lastPoint,t)<this.options.minDistance)return!1;const n=new Date(this.lastPoint.recordedAt).getTime();return!(new Date(t.recordedAt).getTime()-n<this.options.minInterval)}getPoints(){return[...this.points]}getStats(){const t=this.startTime?Math.floor((Date.now()-this.startTime.getTime())/1e3):0,e=this.points.map(i=>i.speed).filter(i=>i!==void 0),n=this.points.map(i=>i.altitude).filter(i=>i!==void 0);return{totalPoints:this.points.length,totalDistance:this.totalDistance,totalDuration:t,avgSpeed:e.length>0?e.reduce((i,h)=>i+h,0)/e.length:0,maxSpeed:e.length>0?Math.max(...e):0,maxAltitude:n.length>0?Math.max(...n):void 0,minAltitude:n.length>0?Math.min(...n):void 0}}clear(){this.points=[],this.lastPoint=null,this.totalDistance=0,this.startTime=null}getStatus(){return{isRecording:this.isRecording,isPaused:this.isPaused}}};const at=s=>{const t=p(null),e=p(!1),n=p(!1),i=p([]),h=p({totalPoints:0,totalDistance:0,totalDuration:0,avgSpeed:0,maxSpeed:0,maxAltitude:void 0,minAltitude:void 0}),g=()=>{t.value=new et({...s,onPointAdded:r=>{var P;i.value=t.value.getPoints(),h.value=t.value.getStats(),(P=s==null?void 0:s.onPointAdded)==null||P.call(s,r)},onError:r=>{var P;(P=s==null?void 0:s.onError)==null||P.call(s,r)}})},c=()=>{t.value||g(),t.value.start(),e.value=!0,n.value=!1},_=()=>{var r;(r=t.value)==null||r.pause(),n.value=!0},y=()=>{var r;(r=t.value)==null||r.resume(),n.value=!1},b=()=>{var r;(r=t.value)==null||r.stop(),e.value=!1,n.value=!1},k=()=>{var r;(r=t.value)==null||r.clear(),i.value=[],h.value={totalPoints:0,totalDistance:0,totalDuration:0,avgSpeed:0,maxSpeed:0,maxAltitude:void 0,minAltitude:void 0}};return{isRecording:D(()=>e.value),isPaused:D(()=>n.value),points:D(()=>i.value),stats:D(()=>h.value),start:c,pause:_,resume:y,stop:b,clear:k}},st={class:"track-recorder-container"},ot={class:"recorder-header"},nt={class:"recorder-content"},it={class:"stats-panel"},lt={class:"stat-card"},rt={class:"value"},ct={class:"stat-card"},dt={class:"value"},ut={class:"stat-card"},vt={class:"value"},pt={class:"stat-card"},mt={class:"value"},ht={class:"recording-info"},gt={class:"info-group"},ft=["disabled"],_t={class:"info-group"},Pt=["disabled"],bt=["value"],kt={class:"info-group"},wt=["disabled"],Dt={class:"points-info"},At={key:0,class:"points-preview"},yt={class:"time"},Mt={class:"coords"},Rt={class:"action-buttons"},Tt=["disabled"],St=K({__name:"TrackRecorder",setup(s){const t=q(),e=p(""),n=p(""),i=p(""),h=p([]),g=p([]),c=p(!1),_=p(!1);let y=null;const{stats:b,points:k,start:r,stop:P,pause:L,resume:$}=at({minDistance:5,minInterval:3e3}),G=l=>{const o=Math.floor(l/3600),d=Math.floor(l%3600/60),M=l%60;return`${o}:${String(d).padStart(2,"0")}:${String(M).padStart(2,"0")}`},U=l=>new Date(l).toLocaleTimeString(),V=async()=>{if(!e.value.trim()){alert("è¯·è¾“å…¥å¾’æ­¥åç§°");return}try{c.value=!0,await r(),g.value=[]}catch(l){console.error("Failed to start recording:",l),c.value=!1,alert("æ— æ³•å¯åŠ¨ä½ç½®è®°å½•ï¼Œè¯·æ£€æŸ¥æƒé™")}},z=()=>{L(),_.value=!0},B=()=>{$(),_.value=!1},S=()=>{P(),c.value=!1},N=async()=>{if(k.value.length===0){alert("æ²¡æœ‰è®°å½•åˆ°è½¨è¿¹ç‚¹");return}try{const l=await T.createTrack({name:e.value,description:n.value,route_id:i.value||null});await T.uploadTrackPoints(l.id,k.value),await T.completeTrack(l.id),alert("å¾’æ­¥è®°å½•ä¿å­˜æˆåŠŸï¼"),t.push({name:"TrackDetail",params:{id:l.id}})}catch(l){console.error("Failed to save track:",l),alert("ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•")}},O=()=>{confirm("ç¡®å®šè¦æ”¾å¼ƒæ­¤æ¬¡è®°å½•å—ï¼Ÿ")&&(k.value=[],g.value=[],e.value="",n.value="",c.value=!1,_.value=!1)};return J(async()=>{try{const l=await X.getRoutes();h.value=l,y=await Z("map-container");const o=await tt()}catch(l){console.error("Failed to initialize:",l)}}),j(()=>{c.value&&S()}),(l,o)=>(v(),u("div",st,[a("div",ot,[o[3]||(o[3]=a("h1",null,"å¼€å§‹å¾’æ­¥",-1)),c.value?(v(),u("button",{key:1,class:"btn-stop",onClick:S}," â¹ åœæ­¢è®°å½• ")):(v(),u("button",{key:0,class:"btn-start",onClick:V}," ğŸ¯ å¼€å§‹è®°å½• "))]),a("div",nt,[o[12]||(o[12]=a("div",{class:"map-section"},[a("div",{id:"map-container",class:"map"})],-1)),a("div",it,[a("div",lt,[o[4]||(o[4]=a("span",{class:"label"},"è·ç¦»",-1)),a("span",rt,f((A(b).totalDistance/1e3).toFixed(2))+" km",1)]),a("div",ct,[o[5]||(o[5]=a("span",{class:"label"},"æ—¶é•¿",-1)),a("span",dt,f(G(A(b).totalDuration)),1)]),a("div",ut,[o[6]||(o[6]=a("span",{class:"label"},"é€Ÿåº¦",-1)),a("span",vt,f(A(b).avgSpeed.toFixed(1))+" km/h",1)]),a("div",pt,[o[7]||(o[7]=a("span",{class:"label"},"çˆ¬å‡",-1)),a("span",mt,f(A(b).totalElevationGain.toFixed(0))+" m",1)])]),a("div",ht,[a("div",gt,[o[8]||(o[8]=a("label",null,"å¾’æ­¥åç§°",-1)),R(a("input",{"onUpdate:modelValue":o[0]||(o[0]=d=>e.value=d),type:"text",placeholder:"ä¸ºè¿™æ¬¡å¾’æ­¥å‘½å...",class:"input",disabled:c.value},null,8,ft),[[x,e.value]])]),a("div",_t,[o[10]||(o[10]=a("label",null,"é€‰æ‹©è·¯çº¿ï¼ˆå¯é€‰ï¼‰",-1)),R(a("select",{"onUpdate:modelValue":o[1]||(o[1]=d=>i.value=d),class:"input",disabled:c.value},[o[9]||(o[9]=a("option",{value:""},"-- æœªå…³è”è·¯çº¿ --",-1)),(v(!0),u(E,null,C(h.value,d=>(v(),u("option",{key:d.id,value:d.id},f(d.name),9,bt))),128))],8,Pt),[[Q,i.value]])]),a("div",kt,[o[11]||(o[11]=a("label",null,"æè¿°",-1)),R(a("textarea",{"onUpdate:modelValue":o[2]||(o[2]=d=>n.value=d),placeholder:"è®°å½•è¿™æ¬¡å¾’æ­¥çš„æ„Ÿå—...",class:"textarea",disabled:c.value,rows:"3"},null,8,wt),[[x,n.value]])])]),a("div",Dt,[a("p",null,"å·²è®°å½• "+f(g.value.length)+" ä¸ªè½¨è¿¹ç‚¹",1),g.value.length>0?(v(),u("div",At,[(v(!0),u(E,null,C(g.value.slice(-5),(d,M)=>(v(),u("div",{key:M,class:"point-item"},[a("span",yt,f(U(d.recorded_at)),1),a("span",Mt,f(d.location.toFixed(4)),1)]))),128))])):w("",!0)]),a("div",Rt,[c.value&&!_.value?(v(),u("button",{key:0,class:"btn btn-secondary",onClick:z}," â¸ æš‚åœ ")):w("",!0),c.value&&_.value?(v(),u("button",{key:1,class:"btn btn-secondary",onClick:B}," â–¶ ç»§ç»­ ")):w("",!0),!c.value&&g.value.length>0?(v(),u("button",{key:2,class:"btn btn-success",onClick:N,disabled:!e.value}," âœ“ å®Œæˆ ",8,Tt)):w("",!0),g.value.length>0?(v(),u("button",{key:3,class:"btn btn-danger",onClick:O}," âœ• æ”¾å¼ƒ ")):w("",!0)])])]))}}),Ut=Y(St,[["__scopeId","data-v-63f91b1e"]]);export{Ut as default};
