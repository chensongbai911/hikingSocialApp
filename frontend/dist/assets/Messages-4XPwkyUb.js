import{k as P,J as W,E as J,r as g,d as S,l as Q,W as G,v as i,q as u,z as o,x as m,A as f,O as K,P as X,L as I,M as D,S as Y}from"./vue-B6Xl8iL6.js";import{u as Z,s as L,g as ee,t as te,c as se}from"./index-CMoLHmYN.js";import"./state-BRWMog1q.js";const ne={class:"min-h-screen bg-gray-50"},oe={class:"sticky-header bg-white p-4 border-b border-gray-100"},ae={class:"flex items-center justify-between mb-4"},re={key:0,class:"text-xs px-2 py-1 bg-red-100 text-red-600 rounded-full"},le={class:"relative"},ie={key:0,class:"absolute top-full left-0 right-0 mt-2 bg-white border border-gray-200 rounded-2xl shadow-lg z-20 max-h-80 overflow-y-auto"},ue=["onClick"],de=["src","alt"],ce={class:"ml-3 flex-1 min-w-0"},ve={class:"font-medium text-gray-800 truncate"},ge={class:"text-sm text-gray-500 truncate"},me={class:"flex justify-end mt-2 space-x-2 text-sm"},fe={key:0,class:"p-4 space-y-3"},he=["onClick"],pe={class:"relative flex-shrink-0"},xe=["src","alt"],ye={key:0,class:"absolute bottom-0 right-0 w-4 h-4 bg-green-500 border-2 border-white rounded-full"},_e={class:"ml-4 flex-1 min-w-0"},ke={class:"flex items-center justify-between mb-1"},be={class:"font-medium text-gray-800 truncate"},we={class:"text-sm text-gray-400 flex-shrink-0"},Ce={class:"text-sm text-gray-500 truncate"},Me={key:0,class:"ml-3 flex-shrink-0 w-6 h-6 bg-red-500 text-white text-xs font-medium rounded-full flex items-center justify-center"},Te={key:1,class:"py-20 text-center text-gray-400"},Se={key:2,class:"py-12 text-center text-gray-400"},O="https://placehold.co/120x120",Oe=P({__name:"Messages",setup(Ie){const j=(n,e=600)=>{let s=0;return(...t)=>{const l=Date.now();l-s>e&&(s=l,n(...t))}},B=W(),z=J(),b=Z(),p=g(""),w=g(!1),h=g(!1),y=g(!1),C=g(1),N=g(20),U=g(0),r=g([]),A=S(()=>r.value.reduce((n,e)=>n+(e.unreadCount||0),0)),R=n=>{if(!n)return"";const e=new Date(n),t=new Date().getTime()-e.getTime();return t<6e4?"刚刚":t<36e5?`${Math.floor(t/6e4)}分钟前`:t<864e5?`${Math.floor(t/36e5)}小时前`:e.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})},$=n=>{const e=String(b.userId);console.log("[Messages mapConversation] 当前用户ID:",e,"原始数据:",{userId1:n.userId1,userId2:n.userId2});const s=String(n.userId1)===e,t=s?n.user2:n.user1,l=s?n.user1UnreadCount:n.user2UnreadCount,c=(t==null?void 0:t.nickname)||(t==null?void 0:t.name)||"陌生人",v=(t==null?void 0:t.avatarUrl)||(t==null?void 0:t.avatar_url)||"",a=n.lastMessageContent||"",d=t!=null&&t.id?String(t.id):void 0;return console.log("[Messages] 映射对话:",{conversationId:n.id,otherUserId:d,otherName:c,otherAvatar:v,lastMessage:a,unread:l}),{id:String(n.id),name:c,avatar:v,lastMessage:a,lastTime:n.lastMessageAt||n.updatedAt||n.createdAt||null,unreadCount:l||0,isOnline:!1,otherUserId:d}},_=async(n=!0)=>{var e,s;if(b.isLoggedIn){n&&(C.value=1,r.value=[]),n?h.value=!0:y.value=!0;try{const t=await ee(C.value,N.value);console.log("[Messages] getConversations 原始响应:",t);const l=(t==null?void 0:t.conversations)||((e=t==null?void 0:t.data)==null?void 0:e.conversations)||[],c=new Map;U.value=(t==null?void 0:t.total)??((s=t==null?void 0:t.data)==null?void 0:s.total)??l.length,console.log("[Messages] 原始对话数:",l.length,"列表:",l),l.map($).forEach(a=>{const d=`c_${a.id}`,x=c.get(d);(!x||a.lastTime&&x.lastTime&&new Date(a.lastTime)>new Date(x.lastTime))&&(c.set(d,a),console.log("[Messages] 添加对话:",{id:a.id,name:a.name,lastTime:a.lastTime}))});const v=Array.from(c.values());console.log("[Messages] 映射后对话数:",v.length,"对话列表:",v.map(a=>({id:a.id,name:a.name,lastMessage:a.lastMessage}))),r.value=n?v:[...r.value,...v].sort((a,d)=>(d.lastTime?new Date(d.lastTime).getTime():0)-(a.lastTime?new Date(a.lastTime).getTime():0)),console.log("[Messages] 最终对话列表:",r.value.map(a=>({id:a.id,name:a.name}))),l.length>0&&(C.value+=1)}catch(t){console.error("[Messages] 加载对话列表失败:",t),te.error((t==null?void 0:t.message)||"加载会话失败")}finally{h.value=!1,y.value=!1}}},k=S(()=>{if(!p.value.trim())return r.value;const n=p.value.toLowerCase();return r.value.filter(e=>e.name.toLowerCase().includes(n)||(e.lastMessage||"").toLowerCase().includes(n))}),E=S(()=>r.value.length<(U.value||r.value.length)),V=j(()=>{y.value||_(!1)},500),q=n=>{M(n),w.value=!1},M=n=>{r.value=r.value.map(e=>e.id===n.id?{...e,unreadCount:0}:e),se(n.id).catch(()=>{}),B.push({name:"ChatWindow",params:{id:n.id},state:{from:"messages"}})},F=(n,e)=>{const s=r.value.findIndex(l=>l.id===n),t=s>=0;if(t){const l=r.value[s];r.value.splice(s,1,{...l,...e})}else r.value.unshift({id:n,name:e.name||"陌生人",avatar:e.avatar||"",lastMessage:e.lastMessage||"",lastTime:e.lastTime||new Date().toISOString(),unreadCount:e.unreadCount??1,isOnline:e.isOnline??!1,otherUserId:e.otherUserId});return r.value=[...r.value].sort((l,c)=>(c.lastTime?new Date(c.lastTime).getTime():0)-(l.lastTime?new Date(l.lastTime).getTime():0)),t},T=[],H=n=>{const e=n.target;if(!e)return;e.scrollHeight-e.scrollTop-e.clientHeight<120&&E.value&&!y.value&&V()};return Q(async()=>{await _();const n=z.query.conversationId;n&&setTimeout(()=>{const e=r.value.find(s=>s.id===n);e&&M(e)},300),T.push(L.onMessageReceived(e=>{var v,a,d;const s=String(e.conversationId||e.conversation_id),t=e.senderId||e.sender_id,l=String(t)===String(b.userId);F(s,{lastMessage:((v=e.message)==null?void 0:v.content)||e.content||"[新消息]",lastTime:((a=e.message)==null?void 0:a.created_at)||e.createdAt||new Date().toISOString(),unreadCount:l?0:(((d=r.value.find(x=>x.id===s))==null?void 0:d.unreadCount)||0)+1,name:e.senderNickname||e.sender_nickname||void 0,avatar:e.senderAvatar||e.sender_avatar||void 0,otherUserId:t?String(t):void 0})||_()})),T.push(L.onOnlineStatusChange(e=>{const s=String(e.userId||e.id);r.value=r.value.map(t=>t.otherUserId===s?{...t,isOnline:e.type==="online"||e.status==="online"}:t)}))}),G(()=>{T.forEach(n=>n())}),(n,e)=>(u(),i("div",ne,[o("div",oe,[o("div",ae,[e[3]||(e[3]=o("h1",{class:"text-2xl font-bold text-gray-800"},"消息中心",-1)),A.value>0?(u(),i("span",re,"未读 "+f(A.value),1)):m("",!0)]),o("div",le,[K(o("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>p.value=s),type:"text",placeholder:"搜索联系人或聊天记录",class:"w-full pl-12 pr-4 py-3 bg-gray-50 rounded-2xl focus:outline-none focus:ring-2 focus:ring-teal-500",onFocus:e[1]||(e[1]=s=>w.value=!0)},null,544),[[X,p.value]]),e[5]||(e[5]=o("svg",{class:"w-6 h-6 text-teal-500 absolute left-4 top-1/2 -translate-y-1/2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1)),w.value&&p.value.trim()&&k.value.length>0?(u(),i("div",ie,[(u(!0),i(I,null,D(k.value,s=>(u(),i("div",{key:s.id,onClick:t=>q(s),class:"flex items-center p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer active:bg-gray-100 transition-colors"},[o("img",{src:s.avatar||O,alt:s.name,class:"w-10 h-10 rounded-full object-cover flex-shrink-0"},null,8,de),o("div",ce,[o("h4",ve,f(s.name||"陌生人"),1),o("p",ge,f(s.lastMessage||"暂无消息"),1)]),e[4]||(e[4]=o("svg",{class:"w-5 h-5 text-gray-400 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"})],-1))],8,ue))),128))])):m("",!0)]),o("div",me,[o("button",{class:"px-3 py-1 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200",onClick:e[2]||(e[2]=()=>{h.value||_(!0)})}," 刷新 ")])]),e[8]||(e[8]=o("div",{class:"px-4 py-2"},[o("h2",{class:"text-lg font-bold text-teal-600"},"最近私聊")],-1)),o("div",{class:"bg-white flex-1 overflow-y-auto",onScrollPassive:H},[h.value&&r.value.length===0?(u(),i("div",fe,[(u(),i(I,null,D(6,s=>o("div",{key:s,class:"flex items-center animate-pulse space-x-4"},[...e[6]||(e[6]=[Y('<div class="w-14 h-14 bg-gray-200 rounded-full"></div><div class="flex-1 space-y-2"><div class="h-4 bg-gray-200 rounded w-1/3"></div><div class="h-3 bg-gray-100 rounded w-2/3"></div></div><div class="w-8 h-4 bg-gray-100 rounded"></div>',3)])])),64))])):m("",!0),(u(!0),i(I,null,D(k.value,s=>(u(),i("div",{key:s.id,onClick:t=>M(s),class:"flex items-center p-4 border-b border-gray-100 active:bg-gray-50 cursor-pointer"},[o("div",pe,[o("img",{src:s.avatar||O,alt:s.name,class:"w-14 h-14 rounded-full object-cover"},null,8,xe),s.isOnline?(u(),i("div",ye)):m("",!0)]),o("div",_e,[o("div",ke,[o("h3",be,f(s.name||"陌生人"),1),o("span",we,f(R(s.lastTime)),1)]),o("p",Ce,f(s.lastMessage||"暂无消息"),1)]),s.unreadCount>0?(u(),i("div",Me,f(s.unreadCount>9?"9+":s.unreadCount),1)):m("",!0)],8,he))),128)),!h.value&&k.value.length===0?(u(),i("div",Te,[...e[7]||(e[7]=[o("svg",{class:"w-20 h-20 mx-auto mb-4 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})],-1),o("p",null,"暂无聊天记录",-1)])])):m("",!0),h.value?(u(),i("div",Se,"加载中...")):m("",!0)],32)]))}});export{Oe as default};
