<template>
  <div class="profile-page">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="sticky top-0 z-10 bg-white border-b border-gray-200">
      <div class="flex items-center justify-between px-4 py-4">
        <button @click="goBack" class="p-2">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
          </svg>
        </button>
        <h1 class="text-xl font-bold text-gray-800">ä¸ªäººèµ„æ–™</h1>
        <button @click="goToSettings" class="p-2">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <path
              d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"
            />
          </svg>
        </button>
      </div>
    </div>

    <div class="px-4 py-6 pb-20">
      <!-- å¤´åƒå’ŒåŸºæœ¬ä¿¡æ¯ -->
      <div class="flex flex-col items-center mb-6">
        <div class="relative mb-4">
          <img
            :src="(userProfile.avatar || defaultAvatar) + '?t=' + avatarTimestamp"
            :alt="userProfile.nickname"
            class="w-28 h-28 rounded-full object-cover border-4 border-white shadow-lg cursor-pointer hover:opacity-80 transition-opacity"
            @click="openAvatarUpload"
          />
          <div
            class="absolute bottom-0 right-0 w-10 h-10 bg-teal-500 rounded-full flex items-center justify-center border-4 border-white cursor-pointer hover:bg-teal-600 transition-colors"
            @click="openAvatarUpload"
          >
            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M3 9.5A1.5 1.5 0 004.5 8h15A1.5 1.5 0 0121 9.5v9a1.5 1.5 0 01-1.5 1.5h-15A1.5 1.5 0 013 18.5v-9zm9-2a4 4 0 110 8 4 4 0 010-8z"
                fill="currentColor"
              />
            </svg>
          </div>
        </div>

        <div class="flex items-center gap-2 mb-1">
          <h2 class="text-2xl font-bold text-gray-800">{{ userProfile.nickname }}</h2>
          <svg
            v-if="userProfile.gender === 'male'"
            class="w-5 h-5 text-blue-500"
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              d="M9 9c0-1.65 1.35-3 3-3s3 1.35 3 3-1.35 3-3 3-3-1.35-3-3zm0 8c0 1.93 2.69 3 6 3s6-1.07 6-3v-1H9v1z"
            />
            <path
              d="M17.5 3h-3v1.5H16v1.59c-.74-.27-1.54-.43-2.38-.43C10.07 5.66 7 8.73 7 12.5S10.07 19.34 13.62 19.34c2.14 0 4.04-1.04 5.22-2.63l1.42 1.42 1.06-1.06-1.42-1.42C20.7 14.48 21 13.46 21 12.5c0-2.36-1.23-4.43-3.09-5.61V5.5h1.5V4h-1.91V3zm-3.88 14.84c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"
            />
          </svg>
          <span class="px-3 py-1 bg-blue-50 text-blue-600 text-sm font-semibold rounded-full">
            {{ userProfile.age }}
          </span>
        </div>
      </div>

      <!-- å…³äºæˆ‘ -->
      <div class="bg-white rounded-2xl shadow-sm p-5 mb-4">
        <h3 class="text-sm font-semibold text-gray-500 mb-3">å…³äºæˆ‘</h3>
        <p class="text-gray-700 leading-relaxed">
          {{ userProfile.bio }}
        </p>
      </div>

      <!-- åœ°åŒºä¿¡æ¯ -->
      <div class="bg-white rounded-2xl shadow-sm p-5 mb-4">
        <h3 class="text-sm font-semibold text-gray-500 mb-3">æ‰€åœ¨åœ°</h3>
        <div class="flex items-center gap-2 text-gray-700">
          <svg class="w-5 h-5 text-teal-500" fill="currentColor" viewBox="0 0 24 24">
            <path
              d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"
            />
          </svg>
          <span>
            {{ getLocationText() }}
          </span>
        </div>
      </div>

      <!-- å¾’æ­¥åå¥½ -->
      <div class="bg-white rounded-2xl shadow-sm p-5 mb-4">
        <h3 class="text-sm font-semibold text-gray-500 mb-3">æˆ‘çš„å¾’æ­¥åå¥½</h3>

        <!-- ç©ºçŠ¶æ€æç¤º -->
        <div v-if="!userProfile.preferences || userProfile.preferences.length === 0" class="text-center py-6">
          <div class="text-4xl mb-2">ğŸ·ï¸</div>
          <p class="text-gray-500 text-sm mb-2">è¿˜æ²¡æœ‰è®¾ç½®å¾’æ­¥åå¥½</p>
          <button
            @click="router.push('/edit-profile')"
            class="text-teal-500 text-xs font-medium hover:underline"
          >
            å»è®¾ç½® â†’
          </button>
        </div>

        <!-- æ ‡ç­¾åˆ—è¡¨ -->
        <div v-else class="flex flex-wrap gap-2">
          <span
            v-for="(tag, index) in userProfile.preferences"
            :key="index"
            class="px-4 py-2 bg-teal-50 text-teal-600 rounded-full text-sm font-medium"
          >
            {{ tag }}
          </span>
        </div>
      </div>

      <!-- ç”Ÿæ´»ç›¸å†Œ -->
      <div class="bg-white rounded-2xl shadow-sm p-5 mb-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-gray-500">ç”Ÿæ´»ç›¸å†Œ</h3>
          <span class="text-xs text-gray-400">{{ userProfile.photos.length }}/9</span>
        </div>

        <!-- ç©ºçŠ¶æ€æç¤º -->
        <div v-if="userProfile.photos.length === 0" class="text-center py-8">
          <div class="text-4xl mb-3">ğŸ“·</div>
          <p class="text-gray-500 text-sm mb-2">è¿˜æ²¡æœ‰ç”Ÿæ´»ç…§ç‰‡</p>
          <p class="text-gray-400 text-xs mb-4">åˆ†äº«ä½ çš„ç²¾å½©ç¬é—´</p>
          <button
            @click="addPhoto"
            class="px-6 py-2 bg-teal-500 text-white text-sm rounded-full hover:bg-teal-600 transition"
          >
            æ·»åŠ ç…§ç‰‡
          </button>
        </div>

        <!-- ç…§ç‰‡ç½‘æ ¼ -->
        <div v-else class="grid grid-cols-3 gap-3">
          <div
            v-for="(photo, index) in userProfile.photos"
            :key="photo.id"
            class="relative aspect-square rounded-2xl overflow-hidden bg-gray-100 group"
          >
            <img
              :src="photo.photo_url"
              :alt="'photo-' + index"
              class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
              @click="previewPhoto(index)"
            />
            <!-- åˆ é™¤æŒ‰é’® -->
            <button
              @click.stop="deletePhoto(photo.id)"
              class="absolute top-2 right-2 w-8 h-8 bg-red-500 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-lg hover:bg-red-600"
            >
              <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                />
              </svg>
            </button>
          </div>
          <!-- æ·»åŠ ç…§ç‰‡æŒ‰é’® -->
          <div
            v-if="userProfile.photos.length < 9"
            class="aspect-square rounded-2xl overflow-hidden bg-gray-50 border-2 border-dashed border-gray-300 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-100 hover:border-teal-400 transition-all"
            @click="addPhoto"
          >
            <svg class="w-8 h-8 text-teal-400 mb-1" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M19 7v2.99s-1.99.01-2 0V7h-3s.01-1.99 0-2h3V2h2v3h3v2h-3zm-3 4V8h-3V5H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-8h-3zM5 19l3-4 2 3 3-4 4 5H5z"
              />
            </svg>
            <span class="text-xs text-teal-500 font-medium">æ·»åŠ ç…§ç‰‡</span>
          </div>
        </div>
      </div>

      <!-- ç¼–è¾‘èµ„æ–™æŒ‰é’® -->
      <button
        @click="editProfile"
        class="w-full py-4 bg-teal-500 text-white rounded-2xl font-semibold text-lg hover:bg-teal-600 transition-colors mb-4 shadow-sm"
      >
        ç¼–è¾‘èµ„æ–™
      </button>

      <!-- éšç§è®¾ç½®å…¥å£ -->
      <button
        @click="goToPrivacySettings"
        class="w-full flex items-center justify-between bg-white rounded-2xl p-5 shadow-sm hover:shadow-md transition-shadow mb-3"
      >
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-teal-50 rounded-full flex items-center justify-center">
            <svg class="w-5 h-5 text-teal-600" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"
              />
            </svg>
          </div>
          <span class="text-gray-800 font-medium">éšç§è®¾ç½®</span>
        </div>
        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
          <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
        </svg>
      </button>

      <!-- é€€å‡ºç™»å½•æŒ‰é’® -->
      <button
        @click="handleLogout"
        class="w-full flex items-center justify-center gap-2 bg-white rounded-2xl p-5 shadow-sm hover:shadow-md transition-all hover:bg-red-50 group"
      >
        <svg
          class="w-5 h-5 text-gray-500 group-hover:text-red-500 transition-colors"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
          />
        </svg>
        <span class="text-gray-700 font-medium group-hover:text-red-500 transition-colors"
          >é€€å‡ºç™»å½•</span
        >
      </button>
    </div>

    <!-- é€€å‡ºç™»å½•ç¡®è®¤å¼¹çª— -->
    <div
      v-if="showLogoutConfirm"
      @click="showLogoutConfirm = false"
      class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
    >
      <div @click.stop class="bg-white rounded-3xl w-full max-w-sm p-6 animate-scale-in">
        <div class="text-center mb-6">
          <div
            class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4"
          >
            <svg
              class="w-8 h-8 text-orange-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
              />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-gray-900 mb-2">ç¡®è®¤é€€å‡ºç™»å½•ï¼Ÿ</h3>
          <p class="text-gray-600 text-sm">é€€å‡ºåéœ€è¦é‡æ–°ç™»å½•æ‰èƒ½ä½¿ç”¨å®Œæ•´åŠŸèƒ½ã€‚</p>
        </div>
        <div class="flex gap-3">
          <button
            @click="showLogoutConfirm = false"
            class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 transition"
          >
            å–æ¶ˆ
          </button>
          <button
            @click="confirmLogout"
            class="flex-1 py-3 rounded-xl bg-orange-500 text-white font-semibold hover:bg-orange-600 transition"
          >
            ç¡®è®¤é€€å‡º
          </button>
        </div>
      </div>
    </div>

    <!-- ç…§ç‰‡é¢„è§ˆå¼¹çª— -->
    <div
      v-if="showPreview"
      class="fixed inset-0 z-50 bg-black bg-opacity-90 flex items-center justify-center"
      @click="closePreview"
    >
      <div class="relative w-full h-full flex items-center justify-center p-4">
        <!-- å…³é—­æŒ‰é’® -->
        <button
          @click="closePreview"
          class="absolute top-4 right-4 w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all z-10"
        >
          <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path
              d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
            />
          </svg>
        </button>

        <!-- ä¸Šä¸€å¼ æŒ‰é’® -->
        <button
          v-if="currentPreviewIndex > 0"
          @click.stop="prevPhoto"
          class="absolute left-4 w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all z-10"
        >
          <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
          </svg>
        </button>

        <!-- ç…§ç‰‡ -->
        <img
          :src="userProfile.photos[currentPreviewIndex]?.photo_url"
          :alt="'preview-' + currentPreviewIndex"
          class="max-w-full max-h-full object-contain"
          @click.stop
        />

        <!-- ä¸‹ä¸€å¼ æŒ‰é’® -->
        <button
          v-if="currentPreviewIndex < userProfile.photos.length - 1"
          @click.stop="nextPhoto"
          class="absolute right-4 w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all z-10"
        >
          <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
          </svg>
        </button>

        <!-- ç…§ç‰‡ç´¢å¼• -->
        <div
          class="absolute bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 bg-white bg-opacity-20 rounded-full text-white text-sm"
        >
          {{ currentPreviewIndex + 1 }} / {{ userProfile.photos.length }}
        </div>
      </div>
    </div>

    <!-- åˆ é™¤ç…§ç‰‡ç¡®è®¤å¼¹çª— -->
    <div
      v-if="showDeletePhotoConfirm"
      @click="showDeletePhotoConfirm = false"
      class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
    >
      <div @click.stop class="bg-white rounded-3xl w-full max-w-sm p-6 animate-scale-in">
        <div class="text-center mb-6">
          <div
            class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"
          >
            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
              />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-gray-900 mb-2">ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿ</h3>
          <p class="text-gray-600 text-sm">åˆ é™¤åæ— æ³•æ¢å¤ï¼Œå…¶ä»–ç”¨æˆ·ä¹Ÿå°†æ— æ³•æŸ¥çœ‹ã€‚</p>
        </div>
        <div class="flex gap-3">
          <button
            @click="showDeletePhotoConfirm = false"
            class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 transition"
          >
            å–æ¶ˆ
          </button>
          <button
            @click="confirmDeletePhoto"
            class="flex-1 py-3 rounded-xl bg-red-500 text-white font-semibold hover:bg-red-600 transition"
          >
            ç¡®è®¤åˆ é™¤
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed, onMounted, ref } from 'vue'
import { useRouter } from 'vue-router'
import { useUserStore } from '@/stores/user'
import { uploadPhotos, compressImage } from '@/utils/imageUpload'
import { DEFAULT_CONFIG } from '@/utils/constants'
import toast from '@/utils/toast'

const router = useRouter()
const userStore = useUserStore()

// é»˜è®¤å¤´åƒ
const defaultAvatar = DEFAULT_CONFIG.AVATAR
const showAvatarUpload = ref(false)
const avatarFile = ref<File | null>(null)
const avatarTimestamp = ref(Date.now())
const isLoading = ref(true)

// ç…§ç‰‡é¢„è§ˆç›¸å…³çŠ¶æ€
const showPreview = ref(false)
const currentPreviewIndex = ref(0)
const showDeletePhotoConfirm = ref(false)
const photoToDelete = ref<string | null>(null)
const showLogoutConfirm = ref(false)

// ä»storeè·å–ç”¨æˆ·æ•°æ®
const currentUser = computed(() => userStore.currentUser)

// ç”¨æˆ·èµ„æ–™æ•°æ® - ä½¿ç”¨computedä»storeæ˜ å°„
const userProfile = computed(() => {
  if (!currentUser.value || isLoading.value) {
    return {
      avatar: defaultAvatar,
      nickname: 'åŠ è½½ä¸­...',
      gender: 'other' as const,
      age: 0,
      bio: '',
      province: '',
      city: '',
      region: '',
      preferences: [],
      photos: [],
    }
  }

  // æå–åå¥½æ ‡ç­¾çš„æ˜¾ç¤ºæ–‡æœ¬
  const preferenceLabels = (currentUser.value.preferences || []).map((p) => p.preference_value)
  // æå–ç…§ç‰‡æ•°æ®ï¼ˆåŒ…å«idå’Œurlï¼‰
  const photos = (currentUser.value.photos || []).map((p) => {
    let photoUrl = p.photo_url || ''
    // å¦‚æœç…§ç‰‡URLæ˜¯ç›¸å¯¹è·¯å¾„ä¸”æ²¡æœ‰å®Œæ•´URLå‰ç¼€ï¼Œæ·»åŠ åŸºç¡€URL
    if (photoUrl && !photoUrl.startsWith('http') && photoUrl.startsWith('/')) {
      const baseURL = import.meta.env.VITE_API_BASE_URL || 'http://115.190.252.62'
      photoUrl = `${baseURL}${photoUrl}`
    }
    return {
      id: p.id,
      photo_url: photoUrl,
    }
  })

  // ç¡®ä¿å¤´åƒ URL æ˜¯å®Œæ•´è·¯å¾„
  let avatarUrl = currentUser.value.avatar_url || defaultAvatar
  // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ä¸”è¿˜æ²¡æœ‰å®Œæ•´URLå‰ç¼€ï¼Œæ·»åŠ åŸºç¡€URL
  if (avatarUrl && !avatarUrl.startsWith('http') && avatarUrl.startsWith('/')) {
    const baseURL = import.meta.env.VITE_API_BASE_URL || 'http://115.190.252.62'
    avatarUrl = `${baseURL}${avatarUrl}`
  }

  return {
    avatar: avatarUrl,
    nickname: currentUser.value.nickname,
    gender: currentUser.value.gender,
    age: currentUser.value.age || 0,
    bio: currentUser.value.bio || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™...',
    province: currentUser.value.province || '',
    city: currentUser.value.city || '',
    region: currentUser.value.region || '',
    preferences: preferenceLabels,
    photos: photos,
  }
})

// è¿”å›ä¸Šä¸€é¡µ
const goBack = () => {
  router.back()
}

// å‰å¾€è®¾ç½®é¡µé¢
const goToSettings = () => {
  // TODO: å®ç°è®¾ç½®é¡µé¢è·¯ç”±
  console.log('å‰å¾€è®¾ç½®é¡µé¢')
}

// ç¼–è¾‘èµ„æ–™
const editProfile = () => {
  router.push('/edit-profile')
}

// æ·»åŠ ç…§ç‰‡
const addPhoto = () => {
  // åˆ›å»ºéšè—çš„ input å…ƒç´ 
  const input = document.createElement('input')
  input.type = 'file'
  input.accept = 'image/*'
  input.multiple = true // æ”¯æŒå¤šé€‰
  input.onchange = async (e: Event) => {
    const target = e.target as HTMLInputElement
    const files = target.files
    if (files && files.length > 0) {
      try {
        // æ£€æŸ¥ç…§ç‰‡æ•°é‡ï¼ˆæœ€å¤š9å¼ ï¼‰
        const currentPhotoCount = userProfile.value.photos.length
        if (currentPhotoCount + files.length > 9) {
          toast.warning(`æœ€å¤šåªèƒ½ä¸Šä¼ 9å¼ ç…§ç‰‡ï¼Œå½“å‰å·²æœ‰${currentPhotoCount}å¼ `)
          return
        }

        toast.info(`æ­£åœ¨ä¸Šä¼ ${files.length}å¼ ç…§ç‰‡...`)

        // ä¸Šä¼ æ‰€æœ‰ç…§ç‰‡
        const fileArray = Array.from(files)
        const newPhotos = await uploadPhotos(fileArray)

        // ç«‹å³æ·»åŠ åˆ°æœ¬åœ°æ˜¾ç¤º
        newPhotos.forEach((photo) => {
          userStore.addLocalPhoto(photo)
        })

        toast.success('ç…§ç‰‡ä¸Šä¼ æˆåŠŸ')
      } catch (error) {
        console.error('ä¸Šä¼ ç…§ç‰‡å¤±è´¥:', error)
        toast.error('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•')
      }
    }
  }
  input.click()
}

// åˆ é™¤ç…§ç‰‡
const deletePhoto = (photoId: string) => {
  photoToDelete.value = photoId
  showDeletePhotoConfirm.value = true
}

// ç¡®è®¤åˆ é™¤ç…§ç‰‡
const confirmDeletePhoto = async () => {
  if (!photoToDelete.value) return

  showDeletePhotoConfirm.value = false

  try {
    toast.info('æ­£åœ¨åˆ é™¤ç…§ç‰‡...')

    // è°ƒç”¨APIåˆ é™¤
    const success = await userStore.deletePhoto(photoToDelete.value)

    if (success) {
      toast.success('ç…§ç‰‡å·²åˆ é™¤')
    }
  } catch (error) {
    console.error('åˆ é™¤ç…§ç‰‡å¤±è´¥:', error)
    toast.error('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•')
  } finally {
    photoToDelete.value = null
  }
}

// é€€å‡ºç™»å½•
const handleLogout = () => {
  showLogoutConfirm.value = true
}

// ç¡®è®¤é€€å‡ºç™»å½•
const confirmLogout = async () => {
  showLogoutConfirm.value = false

  try {
    toast.info('æ­£åœ¨é€€å‡º...')
    await userStore.logout()
    toast.success('å·²é€€å‡ºç™»å½•')
    // è·³è½¬åˆ°ç™»å½•é¡µ
    router.push('/login')
  } catch (error) {
    console.error('é€€å‡ºç™»å½•å¤±è´¥:', error)
    toast.error('é€€å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•')
  }
}

// é¢„è§ˆç…§ç‰‡
const previewPhoto = (index: number) => {
  currentPreviewIndex.value = index
  showPreview.value = true
}

// å…³é—­é¢„è§ˆ
const closePreview = () => {
  showPreview.value = false
}

// ä¸Šä¸€å¼ ç…§ç‰‡
const prevPhoto = () => {
  if (currentPreviewIndex.value > 0) {
    currentPreviewIndex.value--
  }
}

// ä¸‹ä¸€å¼ ç…§ç‰‡
const nextPhoto = () => {
  if (currentPreviewIndex.value < userProfile.value.photos.length - 1) {
    currentPreviewIndex.value++
  }
}

// å‰å¾€éšç§è®¾ç½®
const goToPrivacySettings = () => {
  router.push('/privacy-settings')
}

// æ‰“å¼€å¤´åƒä¸Šä¼ 
const openAvatarUpload = () => {
  const input = document.createElement('input')
  input.type = 'file'
  input.accept = 'image/*'
  input.onchange = async (e: Event) => {
    const target = e.target as HTMLInputElement
    const file = target.files?.[0]
    if (file) {
      try {
        avatarFile.value = file
        await uploadAndUpdateAvatar(file)
      } catch (error) {
        console.error('å¤´åƒä¸Šä¼ å¤±è´¥:', error)
        toast.error('å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•')
      }
    }
  }
  input.click()
}

// ä¸Šä¼ å¹¶æ›´æ–°å¤´åƒ
const uploadAndUpdateAvatar = async (file: File) => {
  try {
    toast.info('æ­£åœ¨ä¸Šä¼ å¤´åƒ...')

    // è°ƒç”¨ userStore ä¸­çš„å¤´åƒä¸Šä¼ æ–¹æ³•
    const newAvatarUrl = await userStore.uploadAvatar(file)

    if (newAvatarUrl) {
      toast.success('å¤´åƒå·²æ›´æ–°')
      // é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼ˆè°ƒç”¨APIè·å–æœ€æ–°æ•°æ®ï¼‰
      await loadUserProfile()
      // æ›´æ–°æ—¶é—´æˆ³å¼ºåˆ¶åˆ·æ–°å›¾ç‰‡
      avatarTimestamp.value = Date.now()
    } else {
      toast.error('å¤´åƒä¸Šä¼ å¤±è´¥')
    }
  } catch (error) {
    console.error('æ›´æ–°å¤´åƒå¤±è´¥:', error)
    toast.error('å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•')
    throw error
  }
}

// è·å–åœ°åŒºæ–‡æœ¬
const getLocationText = () => {
  const { region, province, city } = userProfile.value
  if (region) return region
  const location = [province, city].filter(Boolean).join(' ')
  return location || 'æœªè®¾ç½®'
}

// åŠ è½½ç”¨æˆ·èµ„æ–™
const loadUserProfile = async () => {
  try {
    isLoading.value = true
    // æ¯æ¬¡è¿›å…¥é¡µé¢éƒ½ä»æœåŠ¡å™¨è·å–æœ€æ–°æ•°æ®
    await userStore.fetchCurrentUser()
    console.log('ç”¨æˆ·èµ„æ–™åŠ è½½æˆåŠŸ', currentUser.value)
  } catch (error) {
    console.error('åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥:', error)
    toast.error('åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥')
  } finally {
    isLoading.value = false
  }
}

onMounted(() => {
  loadUserProfile()
})
</script>

<style scoped>
.profile-page {
  min-height: 100vh;
  background: linear-gradient(180deg, #f0fdfa 0%, #ffffff 100%);
}
</style>
