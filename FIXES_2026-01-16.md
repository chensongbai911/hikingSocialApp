## 2026-01-16 ä¿®å¤æ€»ç»“

### ğŸ¯ è§£å†³çš„é—®é¢˜

#### é—®é¢˜ 1ï¼šä¸ªäººèµ„æ–™å¤´åƒå’Œåœ°åŒºæ˜¾ç¤º

**å‰ç«¯ä¿®æ”¹ (d:\coze\frontend\src\components\pages\Profile.vue)**

- âœ… å¤´åƒæ·»åŠ ç‚¹å‡»æ¢å¤´åƒåŠŸèƒ½
- âœ… æ·»åŠ é»˜è®¤å¤´åƒ (DiceBear API)
- âœ… åœ°åŒºé€‰æ‹©å§‹ç»ˆæ˜¾ç¤ºï¼ˆç§»é™¤ v-if æ¡ä»¶ï¼‰
- âœ… æ·»åŠ  `getLocationText()` æ–¹æ³•ç»Ÿä¸€å¤„ç†åœ°åŒºæ˜¾ç¤ºé€»è¾‘

**å‰ç«¯ API (d:\coze\frontend\src\api\user.ts)**

- âœ… æ·»åŠ  `uploadAvatar(formData)` æ–¹æ³•ç”¨äºä¸Šä¼ å¤´åƒæ–‡ä»¶

**å‰ç«¯ Store (d:\coze\frontend\src\stores\user.ts)**

- âœ… æ·»åŠ  `uploadAvatar(file)` æ–¹æ³•å¤„ç†æ–‡ä»¶ä¸Šä¼ å¹¶æ›´æ–°æœ¬åœ°ç”¨æˆ·æ•°æ®

#### é—®é¢˜ 2ï¼šåç«¯éƒ¨ç½²å¤±è´¥ (ecosystem.config.js ç¼ºå¤±)

**åç«¯é…ç½® (d:\coze\backend\ecosystem.config.js)**

- âœ… åˆ›å»ºå®Œæ•´çš„ PM2 é…ç½®æ–‡ä»¶

**åç«¯ package.json**

- âœ… æ·»åŠ  PM2 ç›¸å…³è„šæœ¬:
  - `npm run start:pm2` - å¯åŠ¨ PM2 è¿›ç¨‹
  - `npm run restart:pm2` - é‡å¯ PM2 è¿›ç¨‹
  - `npm run stop:pm2` - åœæ­¢ PM2 è¿›ç¨‹

**åç«¯è·¯ç”± (d:\coze\backend\src\routes\userRoutes.ts)**

- âœ… æ·»åŠ æ–‡ä»¶ä¸Šä¼ ä¸­é—´ä»¶ `uploadSingle('avatar')`

**åç«¯æ§åˆ¶å™¨ (d:\coze\backend\src\controllers\UserController.ts)**

- âœ… ä¿®æ”¹ `updateAvatar()` æ–¹æ³•æ”¯æŒæ–‡ä»¶ä¸Šä¼ 
- âœ… è‡ªåŠ¨ç”Ÿæˆä¸Šä¼ æ–‡ä»¶ URL

---

### ğŸ“‹ å®Œæ•´å®ç°æµç¨‹

#### 1ï¸âƒ£ å‰ç«¯å¤´åƒä¸Šä¼ æµç¨‹

```
Profile.vue ç‚¹å‡»å¤´åƒ
  â†“
openAvatarUpload() æ‰“å¼€æ–‡ä»¶é€‰æ‹©
  â†“
uploadAndUpdateAvatar(file)
  â†“
userStore.uploadAvatar(file)
  â†“
userApi.uploadAvatar(formData)
  â†“
POST /api/v1/users/avatar (multipart/form-data)
  â†“
åç«¯ä¿å­˜æ–‡ä»¶ â†’ è¿”å› URL
  â†“
æ›´æ–° userStore å’Œ localStorage
  â†“
å¤´åƒç«‹å³æ›´æ–°æ˜¾ç¤º
```

#### 2ï¸âƒ£ åç«¯æ–‡ä»¶å¤„ç†æµç¨‹

```
POST /api/v1/users/avatar
  â†“
uploadSingle('avatar') ä¸­é—´ä»¶
  â†“
æ–‡ä»¶ä¿å­˜åˆ° /uploads/avatars/
  â†“
UserController.updateAvatar()
  â†“
æ•°æ®åº“æ›´æ–° avatar_url
  â†“
è¿”å›æ–° URL ç»™å‰ç«¯
```

---

### ğŸ› ï¸ æµ‹è¯•æ­¥éª¤

#### 1. æœ¬åœ°å¼€å‘æµ‹è¯•

```bash
# ç»ˆç«¯1: å¯åŠ¨åç«¯
cd d:\coze\backend
npm run dev

# ç»ˆç«¯2: å¯åŠ¨å‰ç«¯
cd d:\coze\frontend
npm run dev
```

#### 2. åŠŸèƒ½æµ‹è¯•

1. **åœ°åŒºæ˜¾ç¤ºæµ‹è¯•**

   - è¿›å…¥ä¸ªäººèµ„æ–™é¡µ
   - ç¡®è®¤ "æ‰€åœ¨åœ°" å¡ç‰‡æ˜¾ç¤ºï¼ˆæ— è®ºæ˜¯å¦æœ‰æ•°æ®ï¼‰
   - æ£€æŸ¥æ˜¾ç¤ºé€»è¾‘: region > province+city > "æœªè®¾ç½®"

2. **å¤´åƒæ›´æ¢æµ‹è¯•**

   - ç‚¹å‡»å¤´åƒæˆ–ç›¸æœºå›¾æ ‡
   - é€‰æ‹©æœ¬åœ°å›¾ç‰‡
   - ç¡®è®¤ä¸Šä¼ æˆåŠŸæç¤º
   - åˆ·æ–°é¡µé¢éªŒè¯å¤´åƒå·²ä¿å­˜

3. **é»˜è®¤å¤´åƒæµ‹è¯•**
   - æ–°ç”¨æˆ·æˆ–ç”¨æˆ·å¤´åƒä¸ºç©º
   - åº”æ˜¾ç¤ºéšæœºç”Ÿæˆçš„é»˜è®¤å¤´åƒ

#### 3. ç”Ÿäº§éƒ¨ç½²

```bash
# ç¼–è¯‘åç«¯
cd d:\coze\backend
npm run build

# å¯åŠ¨ PM2 è¿›ç¨‹
npm run start:pm2

# æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€
pm2 list

# æŸ¥çœ‹æ—¥å¿—
pm2 logs hiking-app-backend

# é‡å¯
npm run restart:pm2

# åœæ­¢
npm run stop:pm2
```

---

### ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

**å‰ç«¯ (3 ä¸ªæ–‡ä»¶)**

1. `frontend/src/components/pages/Profile.vue` - å¤´åƒäº¤äº’å’Œåœ°åŒºæ˜¾ç¤º
2. `frontend/src/stores/user.ts` - uploadAvatar æ–¹æ³•
3. `frontend/src/api/user.ts` - uploadAvatar API

**åç«¯ (3 ä¸ªæ–‡ä»¶)**

1. `backend/ecosystem.config.js` - PM2 é…ç½®ï¼ˆæ–°å»ºï¼‰
2. `backend/package.json` - PM2 è„šæœ¬
3. `backend/src/routes/userRoutes.ts` - ä¸Šä¼ ä¸­é—´ä»¶
4. `backend/src/controllers/UserController.ts` - æ–‡ä»¶å¤„ç†é€»è¾‘

**è„šæœ¬ (1 ä¸ªæ–‡ä»¶)**

1. `backend/run-backend.bat` - å¯åŠ¨è„šæœ¬ï¼ˆæ–°å»ºï¼‰

---

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **CORS é…ç½®**

   - ç¡®ä¿åç«¯ `.env` ä¸­ `CORS_ORIGIN` åŒ…å«å‰ç«¯åœ°å€
   - ç¤ºä¾‹: `CORS_ORIGIN=http://localhost:5173,http://localhost:3000`

2. **æ–‡ä»¶ä¸Šä¼ é™åˆ¶**

   - æœ€å¤§æ–‡ä»¶: 5MB
   - æ”¯æŒæ ¼å¼: JPEG, PNG, WebP, GIF
   - ä¿å­˜è·¯å¾„: `/uploads/avatars/`

3. **URL æ„å»º**

   - å‰ç«¯æ”¶åˆ°çš„ URL æ ¼å¼: `/uploads/avatars/{filename}`
   - å®Œæ•´ URL: `http://localhost:3000/uploads/avatars/{filename}`

4. **PM2 æ—¥å¿—**
   - é”™è¯¯æ—¥å¿—: `./logs/pm2-error.log`
   - è¾“å‡ºæ—¥å¿—: `./logs/pm2-out.log`

---

### ğŸš€ å¿«é€Ÿå¯åŠ¨

**å¼€å‘ç¯å¢ƒ**

```bash
cd backend && npm run dev
cd frontend && npm run dev
```

**ç”Ÿäº§ç¯å¢ƒ**

```bash
cd backend
npm run build
npm run start:pm2
# å‰ç«¯éœ€è¦å…ˆç¼–è¯‘åéƒ¨ç½²åˆ° CDN æˆ– nginx
```

---

### ğŸ’¡ åç»­ä¼˜åŒ–å»ºè®®

1. **å›¾ç‰‡å‹ç¼©** - ä½¿ç”¨ sharp åº“å‹ç¼©ä¸Šä¼ çš„å¤´åƒ
2. **å›¾ç‰‡è£å‰ª** - å‰ç«¯æ·»åŠ å›¾ç‰‡ç¼–è¾‘åŠŸèƒ½
3. **CDN å­˜å‚¨** - å°†å¤´åƒä¿å­˜åˆ°äº‘å­˜å‚¨ï¼ˆå¦‚ é˜¿é‡Œäº‘ OSSã€ä¸ƒç‰›äº‘ç­‰ï¼‰
4. **ç¼“å­˜ç­–ç•¥** - æ·»åŠ é€‚å½“çš„ HTTP ç¼“å­˜å¤´
5. **å¤´åƒé¢„åŠ è½½** - ä¼˜åŒ–ä¸ªäººèµ„æ–™é¡µåŠ è½½é€Ÿåº¦
